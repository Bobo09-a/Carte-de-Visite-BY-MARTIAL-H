<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<title>Cartes de visite futuristes ‚Äî CR√âATIVE ENTREPRISE</title>
<meta name="theme-color" content="#0b0c12">
<style>
:root{
  --bg:#0b0c12; --panel:#0f1320; --glass1:rgba(255,255,255,.08); --glass2:rgba(255,255,255,.04);
  --line:#1f2436; --txt:#f3f6ff; --muted:#cfd6ff; --orange:#ff8a00; --orange2:#ffc56a;
  --ok:#2fe7a3; --ko:#ff6b6b; --accent:#7aa2ff;
}
*{box-sizing:border-box} html,body{height:100%}
body{
  margin:0;color:var(--txt);font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;
  background:
    radial-gradient(1400px 900px at 88% -10%, #151b39 0, transparent 60%),
    radial-gradient(900px 600px at 0% 110%, #1a132c 0, transparent 60%),
    linear-gradient(180deg,#0b0c12,#090a10);
  -webkit-tap-highlight-color:transparent; scroll-behavior:smooth;
}
a{color:var(--accent);text-decoration:none}
header{
  position:sticky;top:0;z-index:40;
  background:linear-gradient(180deg,rgba(12,14,22,.9),rgba(10,12,18,.75));backdrop-filter:blur(10px);
  border-bottom:1px solid var(--line)
}
.head{max-width:1180px;margin:0 auto;padding:8px 10px;display:flex;align-items:center;gap:10px;justify-content:space-between}
.brand{display:flex;gap:10px;align-items:center;min-width:0}
.logo{width:28px;height:28px;border-radius:9px;background:linear-gradient(135deg,var(--orange),var(--orange2));
  box-shadow:0 10px 28px rgba(255,138,0,.35), inset 0 0 14px rgba(255,255,255,.2)}
.title{font-weight:900;letter-spacing:.02em;white-space:nowrap}
.subtitle{color:var(--muted);font-size:.82rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:58vw}
.pill{border:1px solid var(--line);border-radius:999px;padding:.28rem .6rem;background:linear-gradient(180deg,var(--glass1),var(--glass2));font-weight:800;font-size:.9rem}

.wrap{max-width:1180px;margin:8px auto 84px;padding:0 10px}
.wizard{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,var(--glass1),var(--glass2));backdrop-filter:blur(10px);padding:10px}
.steps{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
.step{display:flex;align-items:center;gap:6px;padding:.35rem .55rem;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-size:.86rem;cursor:pointer}
.step.active{outline:2px solid rgba(255,138,0,.6)}
h2{margin:.2rem 0 .45rem;font-size:1.05rem}
.muted{color:var(--muted)} small.muted{font-size:.9rem}
.row{display:flex;gap:8px;flex-wrap:wrap} .row>*{flex:1}
input[type=text],input[type=url],input[type=color],input[type=number],textarea,select{
  width:100%;padding:.65rem .7rem;border:1px solid #2a2f44;border-radius:10px;background:#0d111c;color:#f3f6ff
}
input[type=file]{width:100%}
.btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:.6rem .85rem;font-weight:800;color:#f3f6ff;background:linear-gradient(180deg,rgba(26,28,40,.95),rgba(14,16,26,.95));cursor:pointer}
.btn.primary{color:#0a0c12;border-color:transparent;background:linear-gradient(135deg,rgba(255,138,0,.9),rgba(255,180,90,.9))}
.btn.ghost{background:transparent}
.btn.sm{padding:.45rem .6rem;font-size:.9rem}
.notice{border:1px dashed #343a55;border-radius:12px;padding:8px;background:rgba(255,255,255,.03)}

.grid{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:980px){ .grid{grid-template-columns:1fr 1fr} }

.templates{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
.tpl{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));cursor:pointer}
.tpl.sel{outline:2px solid rgba(255,138,0,.7)}

.canvasWrap{display:grid;place-items:center;background:#0c0f16;border:1px dashed #2a2f44;border-radius:12px;padding:6px}
canvas{max-width:100%;background:#fff;border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
.footerBar{position:fixed;left:0;right:0;bottom:0;z-index:45;display:flex;justify-content:center}
.bar{max-width:1180px;margin:0 auto 8px;padding:6px 8px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(180deg,var(--glass1),var(--glass2));backdrop-filter:blur(10px);display:flex;gap:6px;align-items:center}
.grow{flex:1}
.ok{color:var(--ok)} .ko{color:var(--ko)}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:78px;padding:.55rem .8rem;border:1px solid var(--line);border-radius:10px;background:linear-gradient(180deg,var(--glass1),var(--glass2));z-index:50}

.editor{display:grid;grid-template-columns:1fr;gap:8px}
@media(min-width:1120px){ .editor{grid-template-columns:1fr 320px} }
.panel{border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,var(--glass1),var(--glass2));padding:8px}
.layer{display:flex;align-items:center;gap:8px;padding:6px;border:1px solid #2a2f44;border-radius:10px;background:#0d111c}
.layer.sel{outline:2px solid rgba(123,157,255,.6)}
.tools{display:flex;gap:6px;flex-wrap:wrap}
.sp{height:1px;background:#242a44;margin:8px 0}

footer.site{
  margin:14px 0 92px; display:flex; justify-content:center
}
.footerBox{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center;
  border:1px solid var(--line); border-radius:999px; padding:8px 12px;
  background:linear-gradient(180deg,var(--glass1),var(--glass2)); backdrop-filter:blur(10px)
}
footer.site a{display:inline-flex;align-items:center;gap:6px}
</style>
</head>
<body>
<header>
  <div class="head">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">CR√âATIVE ENTREPRISE ‚Äî Cartes de visite</div>
        <div class="subtitle">Bienvenue ü§ó cr√©√© par <b>Martial H</b> ‚Äî gratuit, ultra-futuriste, modifiable au doigt</div>
      </div>
    </div>
    <div class="pill" id="status">√âtape 1/7</div>
  </div>
</header>

<div class="wrap">
  <div class="wizard">
    <div class="steps" id="steps"></div>

    <!-- 1) Mod√®le & palette -->
    <section data-step="1">
      <h2>1) Mod√®les & couleurs</h2>
      <div class="row">
        <label>Cat√©gorie de mod√®le
          <select id="cat">
            <option value="all">Tous</option>
            <option value="glass">Glass</option>
            <option value="waves">Vagues</option>
            <option value="angles">Angles/Tech</option>
            <option value="diagonal">Diagonales</option>
            <option value="circles">Cercles</option>
            <option value="ribbon">Rubans</option>
            <option value="luxe">Luxe sombre</option>
            <option value="mesh">Mesh/Aurora</option>
            <option value="grid">Lignes/Grilles</option>
            <option value="neon">N√©on/Stripes</option>
            <option value="shards">Shards/Polygones</option>
            <option value="circuit">Circuit</option>
          </select>
        </label>
        <label>Couleur A<input id="c1" type="color" value="#ff8a00"></label>
        <label>Couleur B<input id="c2" type="color" value="#ffc56a"></label>
        <div style="display:flex;gap:6px;align-items:end">
          <button class="btn sm" id="randomTpl">Al√©atoire</button>
          <button class="btn sm" id="regen">R√©g√©n√©rer 100</button>
        </div>
      </div>
      <small class="muted">Tape pour choisir ‚Äî les previews sont neutres.</small>
      <div class="templates" id="tplGrid"></div>
    </section>

    <!-- 2) Identit√© -->
    <section data-step="2" hidden>
      <h2>2) Identit√©</h2>
      <div class="row">
        <label>Nom complet<input id="name" type="text" placeholder="Nom Pr√©nom"></label>
        <label>Poste / Fonction<input id="role" type="text" placeholder="Poste"></label>
      </div>
      <div class="row">
        <label>Entreprise<input id="company" type="text" placeholder="Entreprise (optionnel)"></label>
        <label>Slogan<input id="tagline" type="text" placeholder="Phrase d‚Äôaccroche (optionnel)"></label>
      </div>
      <div class="row notice">
        <div>
          <b>Taille des textes (anti-d√©bordement auto)</b>
          <div class="row" style="margin-top:6px">
            <label>Nom (px) <input id="sizeName" type="number" min="14" max="38" value="24"></label>
            <label>Sous-titre (px) <input id="sizeSub" type="number" min="10" max="24" value="16"></label>
            <label>Corps (px) <input id="sizeBody" type="number" min="10" max="19" value="12"></label>
          </div>
          <label style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="autofit" type="checkbox" checked>Auto-ajuster pour ne pas d√©passer
          </label>
        </div>
      </div>
    </section>

    <!-- 3) Contacts -->
    <section data-step="3" hidden>
      <h2>3) Contacts</h2>
      <div class="row">
        <label>T√©l√©phones (s√©par√©s par ;)<input id="phones" type="text" placeholder="+229‚Ä¶ ; +33‚Ä¶"></label>
      </div>
      <div class="row">
        <label>Emails (s√©par√©s par ;)<input id="emails" type="text" placeholder="exemple@domaine.com"></label>
      </div>
      <div class="row">
        <label>Site web<input id="website" type="url" placeholder="https://site.com"></label>
        <label>Adresse<input id="address" type="text" placeholder="Adresse compl√®te (optionnel)"></label>
      </div>
    </section>

    <!-- 4) Style -->
    <section data-step="4" hidden>
      <h2>4) Style avanc√©</h2>
      <div class="row">
        <label>Forme des coins
          <select id="corner">
            <option value="round">Arrondis</option>
            <option value="cut">Coup√©s</option>
            <option value="notch">Encoche</option>
          </select>
        </label>
        <label>Rayon/encoche (px)<input id="radius" type="number" min="0" max="40" value="16"></label>
        <label>Effet glass
          <select id="glass">
            <option value="soft">Doux</option>
            <option value="strong">Marqu√©</option>
            <option value="off">Aucun</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>QR Code (URL ou vide)<input id="qr" type="url" placeholder="https://votre-lien.com"></label>
        <label>M√©tier (ic√¥ne)<select id="job">
          <option value="">‚Äî (aucun)</option>
          <option>D√©veloppeur</option><option>Designer</option><option>Photographe</option><option>M√©decin</option>
          <option>Avocat</option><option>Immobilier</option><option>Chef cuisinier</option><option>Ing√©nieur</option>
        </select></label>
      </div>
    </section>

    <!-- 5) Visuels -->
    <section data-step="5" hidden>
      <h2>5) Visuels</h2>
      <div class="row">
        <label>Logo / Photo<input id="logo" type="file" accept="image/*"></label>
        <label>Image de fond (optionnel)<input id="bgimg" type="file" accept="image/*"></label>
      </div>
      <div class="notice muted">Les images restent sur ton appareil. Rien n‚Äôest envoy√©.</div>
    </section>

    <!-- 6) √âditeur -->
    <section data-step="6" hidden>
      <h2>6) √âditeur ‚Äî bouge, redimensionne, pivote ‚ú® (Recto/Verso)</h2>
      <div class="tools" style="margin-bottom:6px">
        <span class="muted">Face: </span>
        <button class="btn sm" id="faceFront">Recto</button>
        <button class="btn sm" id="faceBack">Verso</button>
        <span class="muted" style="margin-left:8px">Rep√®res: </span>
        <button class="btn sm" id="toggleGuides">Activer</button>
      </div>
      <div class="editor">
        <div class="panel">
          <div class="canvasWrap"><canvas id="editor" width="1005" height="650" style="touch-action:none"></canvas></div>
          <div class="tools" style="margin-top:6px">
            <button class="btn sm" id="addText">+ Texte</button>
            <button class="btn sm" id="addGlass">+ Bloc glass</button>
            <button class="btn sm" id="addJob">+ Ic√¥ne m√©tier</button>
            <button class="btn sm" id="addLogo">+ Logo</button>
            <button class="btn sm" id="addQR">+ QR</button>
            <button class="btn sm" id="lockLayer">üîí/üîì</button>
            <button class="btn sm" id="deleteLayer">üóëÔ∏è</button>
          </div>
        </div>
        <div class="panel">
          <h3 style="margin:.2rem 0 .3rem">Calques</h3>
          <div id="layers" class="grid" style="grid-template-columns:1fr;"></div>
          <div class="sp"></div>
          <h3 style="margin:.2rem 0 .3rem">Propri√©t√©s</h3>
          <div id="props" class="grid" style="grid-template-columns:1fr;"></div>
          <div class="tools" style="margin-top:6px">
            <button class="btn sm" id="toFront">Monter</button>
            <button class="btn sm" id="toBack">Descendre</button>
            <button class="btn sm ghost" id="resetLayout">R√©initialiser face</button>
          </div>
        </div>
      </div>
    </section>

    <!-- 7) T√©l√©chargement -->
    <section data-step="7" hidden>
      <h2>7) T√©l√©chargement</h2>
      <small class="muted">Par d√©faut, un petit filigrane ‚ÄúCR√âATIVE ENTREPRISE ‚Äî signe‚Äù.</small>
      <div class="row" style="margin-top:6px">
        <button class="btn" id="dlMarked">PNG HD (recto+verso, filigran√©)</button>
        <button class="btn" id="dlMarkedPdf">PDF 2 pages (filigran√©)</button>
      </div>
      <div class="row notice">
        <div class="row">
          <label>Code pour export propre (sans filigrane)
            <input id="proCode" type="text" placeholder="Entrer le code ici">
          </label>
          <button class="btn primary" id="dlClean">Exporter SANS filigrane</button>
        </div>
        <small class="muted">Code requis : <b>CREATIVE</b> (insensible √† la casse).</small>
      </div>
    </section>
  </div>
</div>

<div class="footerBar">
  <div class="bar">
    <button class="btn sm" id="prev">‚Üê Retour</button>
    <div class="grow" id="hint" style="text-align:center">Compl√®te l‚Äô√©tape puis appuie sur <b>Suivant</b>.</div>
    <button class="btn sm primary" id="next">Suivant ‚Üí</button>
  </div>
</div>

<footer class="site">
  <div class="footerBox">
    <a href="https://www.facebook.com/share/16WSwBEq3M/?mibextid=wwXIfr" target="_blank" rel="noopener">üìò Facebook</a>
    <span class="muted">‚Ä¢</span>
    <a href="https://creikfmx.mychariow.com/" target="_blank" rel="noopener">üõçÔ∏è Boutique Chariow</a>
    <span class="muted">‚Ä¢</span>
    <a href="https://wa.me/22952964028" target="_blank" rel="noopener">üí¨ WhatsApp</a>
  </div>
</footer>

<div id="toast" class="toast" hidden>Message</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
(()=>{'use strict';
/* ===== Helpers ===== */
const $=(s,r=document)=>r.querySelector(s); const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const toast=t=>{const el=$('#toast');el.textContent=t;el.hidden=false;setTimeout(()=>el.hidden=true,1600);};
const setStatus=t=>$('#status').textContent=t;
const fileToDataURL=f=>new Promise((res,rej)=>{const r=new FileReader();r.onload=()=>res(r.result);r.onerror=rej;r.readAsDataURL(f);});
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

/* ===== Consts ===== */
const W=1005,H=650, SAFE={x:40,y:40,w:W-80,h:H-80};
const CAT_ORDER=['glass','waves','angles','diagonal','circles','ribbon','luxe','mesh','grid','neon','shards','circuit'];

/* ===== State ===== */
const S=JSON.parse(localStorage.getItem('card_state_ultra')||'{}');
Object.assign(S,{
  step:Number(S.step||1),
  template:S.template||{cat:'glass', idx:0, seed:0},
  c1:S.c1||'#ff8a00', c2:S.c2||'#ffc56a',
  name:S.name||'', role:S.role||'', company:S.company||'', tagline:S.tagline||'',
  sizeName:Number(S.sizeName||24), sizeSub:Number(S.sizeSub||16), sizeBody:Number(S.sizeBody||12),
  autofit: S.autofit!==false,
  phones:S.phones||'', emails:S.emails||'', website:S.website||'', address:S.address||'',
  socials:S.socials||'',
  corner:S.corner||'round', radius:Number(S.radius||16), glass:S.glass||'soft',
  job:S.job||'', qr:S.qr||'',
  logo:S.logo||null, bgimg:S.bgimg||null,
  guides:!!S.guides, side:S.side||'front',
  layersFront:S.layersFront||[], layersBack:S.layersBack||[]
});
const save=()=>localStorage.setItem('card_state_ultra',JSON.stringify(S));

/* ===== Steps UI ===== */
const stepsMeta=['Mod√®les','Identit√©','Contacts','Style','Visuels','√âditeur','T√©l√©chargement'];
const stepsBox=$('#steps'); stepsBox.innerHTML='';
stepsMeta.forEach((t,i)=>{const b=document.createElement('div');b.className='step';b.dataset.i=String(i+1);b.innerHTML=`<b>${i+1}</b> ${t}`;b.onclick=()=>goto(i+1);stepsBox.appendChild(b);});
function showStep(n){
  $$('section[data-step]').forEach(s=>s.hidden=Number(s.dataset.step)!==n);
  $$('.step').forEach(s=>s.classList.toggle('active',Number(s.dataset.i)===n));
  $('#prev').disabled=n===1; $('#next').textContent=n===7?'Terminer':'Suivant ‚Üí';
  setStatus(`√âtape ${n}/7`);
  if(n===1) buildTpls(); if(n===6){ ensureBaseLayers(); drawEditor(); buildLayersUI(); }
}
function goto(n){ S.step=Math.max(1,Math.min(7,Number(n)||1)); save(); showStep(S.step); }
$('#prev').onclick=()=>goto(S.step-1);
$('#next').onclick=()=>{ if(S.step<7) goto(S.step+1); else toast('Tu peux t√©l√©charger maintenant.'); };
showStep(S.step);

/* ===== Bind fields (toujours sync + redraw si √©tape 6) ===== */
function syncAndMaybeRedraw(){
  syncBaseLayersFromFields();
  if(S.step===6){ drawEditor(); buildLayersUI(); }
}
function bindText(id){ const el=$('#'+id); if(!el) return; el.value=S[id]??''; el.oninput=()=>{ S[id]=el.value; save(); syncAndMaybeRedraw(); }; }
['name','role','company','tagline','phones','emails','website','address','qr','socials'].forEach(bindText);
['c1','c2'].forEach(id=>{const el=$('#'+id); el.value=S[id]; el.oninput=()=>{S[id]=el.value; save(); if(S.step===6) drawEditor(); };});
['sizeName','sizeSub','sizeBody'].forEach(id=>{const el=$('#'+id); el.value=S[id]; el.oninput=()=>{const v=clamp(+el.value||0,+el.min,+el.max); S[id]=v; el.value=v; save(); syncAndMaybeRedraw(); };});
$('#autofit').checked=!!S.autofit; $('#autofit').onchange=()=>{S.autofit=$('#autofit').checked; save(); syncAndMaybeRedraw();};
$('#corner').value=S.corner; $('#corner').oninput=()=>{S.corner=$('#corner').value; save(); if(S.step===6) drawEditor();}
$('#radius').value=S.radius; $('#radius').oninput=()=>{S.radius=clamp(+$('#radius').value||0,0,40); save(); if(S.step===6) drawEditor();}
$('#glass').value=S.glass; $('#glass').oninput=()=>{S.glass=$('#glass').value; save(); if(S.step===6) drawEditor();}
$('#job').value=S.job; $('#job').oninput=()=>{S.job=$('#job').value; save(); if(S.step===6) drawEditor();}
$('#logo').onchange=async e=>{const f=e.target.files[0]; if(!f) return; S.logo=await fileToDataURL(f); save(); ensureBaseLayers(); if(S.step===6) drawEditor();};
$('#bgimg').onchange=async e=>{const f=e.target.files[0]; if(!f) return; S.bgimg=await fileToDataURL(f); save(); if(S.step===6) drawEditor();};

/* ===== Templates ===== */
const catSel=$('#cat'); catSel.oninput=()=>buildTpls();
$('#regen').onclick=()=>buildTpls(true);
$('#randomTpl').onclick=()=>{ const idx=Math.floor(Math.random()*100); const cat=CAT_ORDER[idx%CAT_ORDER.length]; S.template={cat, idx, seed:idx}; save(); buildTpls(); if(S.step===6) drawEditor(); };

function buildTpls(force=false){
  const grid=$('#tplGrid'); grid.innerHTML='';
  const chosen=catSel.value;
  let count=0, idx=0;
  while(count<100){
    const cat = CAT_ORDER[idx%CAT_ORDER.length]; idx++;
    if(chosen!=='all' && cat!==chosen) continue;
    const seed=count;
    const c=document.createElement('canvas'); c.width=260; c.height=160; const ctx=c.getContext('2d');
    preview(ctx, {cat, seed}, S.c1,S.c2);
    const wrap=document.createElement('div'); wrap.className='tpl'+(S.template.cat===cat && S.template.seed===seed?' sel':''); wrap.appendChild(c);
    wrap.onclick=()=>{ S.template={cat, idx:count, seed}; save(); [...grid.children].forEach(x=>x.classList.remove('sel')); wrap.classList.add('sel'); if(S.step===6) drawEditor(); };
    grid.appendChild(wrap);
    count++;
  }
}
function preview(ctx,tpl,c1,c2){
  const Wc=ctx.canvas.width,Hc=ctx.canvas.height;
  const g=ctx.createLinearGradient(0,0,Wc,Hc); g.addColorStop(0,c1); g.addColorStop(1,c2);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,Wc,Hc);
  const s = (tpl.seed%5)+1;
  switch(tpl.cat){
    case 'glass': ctx.fillStyle=g; wave(ctx,0,Hc*.58,Wc,Hc*.7,20+6*s); ctx.fill(); glossy(ctx,Wc,Hc); break;
    case 'waves': ctx.fillStyle=g; wave(ctx,0,Hc*.55,Wc,Hc*.68,18+4*s); ctx.fill(); break;
    case 'angles': poly(ctx,[0,0,Wc*.72,0,Wc,Hc*.36,Wc,Hc,0,Hc,0,0]); ctx.fill(); break;
    case 'diagonal': ctx.fillStyle=g; poly(ctx,[0,Hc,Wc*.6,0,Wc,0,Wc,Hc,0,Hc],g); break;
    case 'circles': ctx.fillStyle=g; circle(ctx,Wc*.25,Hc*.65,40+6*s); ctx.fill(); ctx.globalAlpha=.12; circle(ctx,Wc*.78,Hc*.35,50+8*s); ctx.fill(); ctx.globalAlpha=1; break;
    case 'ribbon': ctx.fillStyle=g; poly(ctx,[0,Hc*.65,Wc,Hc*.35,Wc,Hc,0,Hc]); ctx.fill(); break;
    case 'luxe': ctx.fillStyle='#0b0f26'; ctx.fillRect(0,0,Wc,Hc); ctx.strokeStyle='rgba(255,255,255,.18)'; for(let i=0;i<6+s;i++){ ctx.beginPath(); ctx.moveTo(0,i*26+18); ctx.lineTo(Wc,i*26+8); ctx.stroke(); } ctx.fillStyle=g; circle(ctx,Wc*.16,Hc*.22,28+4*s); ctx.fill(); break;
    case 'mesh': aurora(ctx,Wc,Hc,c1,c2, tpl.seed); break;
    case 'grid': ctx.strokeStyle='rgba(0,0,0,.12)'; for(let x=0;x<Wc;x+=16) line(ctx,x,0,x,Hc); for(let y=0;y<Hc;y+=16) line(ctx,0,y,Wc,y); ctx.fillStyle=g; poly(ctx,[0,0,Wc*.6,0,0,Hc*.3,0,0]); ctx.fill(); break;
    case 'neon': stripes(ctx,Wc,Hc,c1,c2, tpl.seed); break;
    case 'shards': shards(ctx,Wc,Hc,c1,c2,tpl.seed); break;
    case 'circuit': circuit(ctx,Wc,Hc,c1,c2,tpl.seed); break;
  }
  function line(c,x1,y1,x2,y2){ c.beginPath(); c.moveTo(x1,y1); c.lineTo(x2,y2); c.stroke(); }
  function circle(c,x,y,r){ c.beginPath(); c.arc(x,y,r,0,Math.PI*2); }
  function poly(c,pts){ c.beginPath(); c.moveTo(pts[0],pts[1]); for(let i=2;i<pts.length;i+=2) c.lineTo(pts[i],pts[i+1]); c.closePath(); }
  function wave(c,x0,y0,w,h,amp){ c.beginPath(); c.moveTo(0,Hc); c.lineTo(0,y0); for(let x=0;x<=Wc;x+=10){ const y=y0 + Math.sin((x/Wc)*Math.PI)*amp; c.lineTo(x,y); } c.lineTo(Wc,Hc); c.closePath(); }
  function glossy(c,W,H){ c.globalAlpha=.2; const grad=c.createLinearGradient(0,0,W,0); grad.addColorStop(0,'#fff'); grad.addColorStop(1,'transparent'); c.fillStyle=grad; c.fillRect(W*.6,0,W*.4,H); c.globalAlpha=1; }
  function aurora(c,W,H,a,b,seed){ const r=(n)=>((seed*9301+49297*n)%233280)/233280; const g=c.createLinearGradient(0,0,W,H); g.addColorStop(0,a); g.addColorStop(1,b); c.fillStyle='#fff'; c.fillRect(0,0,W,H); c.globalAlpha=.7; for(let i=0;i<3;i++){ const x=W*r(i), y=H*r(i+1), rx=80+80*r(i+2), ry=60+50*r(i+3); const p=c.createRadialGradient(x,y,10,x,y,Math.max(rx,ry)); p.addColorStop(0, a); p.addColorStop(1, 'transparent'); c.fillStyle=p; c.beginPath(); c.ellipse(x,y,rx,ry, r(i+4)*Math.PI, 0, Math.PI*2); c.fill(); } c.globalAlpha=1; }
  function stripes(c,W,H,a,b,seed){ c.fillStyle='#fff'; c.fillRect(0,0,W,H); const n=8+ (seed%5); for(let i=0;i<n;i++){ const t=i/n; const grad=c.createLinearGradient(0,0,W,H); grad.addColorStop(0,a); grad.addColorStop(1,b); c.fillStyle=grad; c.globalAlpha=.25; const y=(H/n)*i; c.fillRect(-20,y,W+40,10+ (i%3)*6); } c.globalAlpha=1; }
  function shards(c,W,H,a,b,seed){ c.fillStyle='#fff'; c.fillRect(0,0,W,H); const r=(n)=>((seed*9301+49297*n)%233280)/233280; for(let k=0;k<6;k++){ c.beginPath(); c.moveTo(W*r(k), H*r(k+1)); for(let j=0;j<4;j++){ c.lineTo(W*r(k+j+2), H*r(k+j+3)); } c.closePath(); const grad=c.createLinearGradient(0,0,W,H); grad.addColorStop(0,a); grad.addColorStop(1,b); c.fillStyle=grad; c.globalAlpha=.18; c.fill(); } c.globalAlpha=1; }
  function circuit(c,W,H,a,b,seed){ c.fillStyle='#fff'; c.fillRect(0,0,W,H); c.strokeStyle='rgba(0,0,0,.22)'; c.lineWidth=1; for(let i=0;i<8;i++){ c.beginPath(); const y=(H/9)*(i+1); c.moveTo(10,y); for(let x=10;x<W-10;x+=40){ c.lineTo(x+20,y); c.arc(x+20,y,6,Math.PI,0); } c.stroke(); } c.globalAlpha=.2; const grad=c.createLinearGradient(0,0,W,H); grad.addColorStop(0,a); grad.addColorStop(1,b); c.fillStyle=grad; c.fillRect(0,0,W,H); c.globalAlpha=1; }
}

/* ===== Editor layers ===== */
const editor=$('#editor'); const ectx=editor.getContext('2d');
let layersFront=S.layersFront, layersBack=S.layersBack, sel=null, drag=null;
function layers(){ return S.side==='front'? layersFront : layersBack; }
function setLayers(L){ if(S.side==='front') layersFront=L; else layersBack=L; S.layersFront=layersFront; S.layersBack=layersBack; save(); }
function newId(){ return 'L'+Math.random().toString(36).slice(2,8); }

function ensureBaseLayers(){
  let L=layers();
  if(!L.length){
    L=[
      {id:newId(),type:'text',bind:'name',text:S.name||'Nom Pr√©nom',x:SAFE.x,y:120,w:560,h:40,size:S.sizeName,weight:800,align:'left',color:'#0d0f16',rot:0},
      {id:newId(),type:'text',bind:'role',text:S.role||'Poste',x:SAFE.x,y:160,w:600,h:30,size:S.sizeSub,weight:600,align:'left',color:'#0d0f16',rot:0},
      {id:newId(),type:'text',bind:'company',text:S.company||'',x:SAFE.x,y:40,w:600,h:26,size:Math.min(20,Math.max(12,S.sizeSub)),weight:700,align:'left',color:'#0d0f16',rot:0},
      {id:newId(),type:'text',bind:'tagline',text:S.tagline||'',x:SAFE.x,y:70,w:600,h:24,size:Math.max(11,S.sizeBody),weight:400,align:'left',color:'rgba(0,0,0,.78)',rot:0},
      {id:newId(),type:'contacts',x:SAFE.x,y:210,w:600,h:180,size:S.sizeBody,weight:400,align:'left',color:'#0d0f16',rot:0},
      {id:newId(),type:'socials',x:W-360,y:210,w:300,h:180,size:S.sizeBody,weight:400,align:'left',color:'#0d0f16',rot:0}
    ];
    if(S.logo) L.push({id:newId(),type:'logo',x:W*0.82-60,y:H*0.32-60,w:120,h:120,rot:0});
    if(S.qr) L.push({id:newId(),type:'qr',x:W-240,y:H-240,w:180,h:180,rot:0});
    setLayers(L);
  }
}
function syncBaseLayersFromFields(){
  layersFront.forEach(l=>{
    if(l.type==='text' && l.bind){ l.text=(S[l.bind]||''); if(l.bind==='name') l.size=S.sizeName; if(l.bind==='role') l.size=S.sizeSub; if(l.bind==='company') l.size=Math.min(20,Math.max(12,S.sizeSub)); if(l.bind==='tagline') l.size=Math.max(11,S.sizeBody); }
    if(l.type==='contacts' || l.type==='socials'){ l.size=S.sizeBody; }
  });
  layersBack.forEach(l=>{
    if(l.type==='text' && l.bind){ l.text=(S[l.bind]||''); if(l.bind==='name') l.size=S.sizeName; if(l.bind==='role') l.size=S.sizeSub; if(l.bind==='company') l.size=Math.min(20,Math.max(12,S.sizeSub)); if(l.bind==='tagline') l.size=Math.max(11,S.sizeBody); }
    if(l.type==='contacts' || l.type==='socials'){ l.size=S.sizeBody; }
  });
  save();
}

/* ===== Background & overlay ===== */
function beginClip(ctx){
  const r=clamp(S.radius,0,40);
  ctx.save(); ctx.beginPath();
  if(S.corner==='round'){
    roundRectPath(ctx,0,0,W,H,r);
  } else if(S.corner==='cut'){
    const c=r||16; ctx.moveTo(c,0); ctx.lineTo(W-c,0); ctx.lineTo(W,c); ctx.lineTo(W,H-c); ctx.lineTo(W-c,H); ctx.lineTo(c,H); ctx.lineTo(0,H-c); ctx.lineTo(0,c); ctx.closePath();
  } else { // notch (simple coupe)
    const c=r||16; ctx.moveTo(c,0); ctx.lineTo(W-c,0); ctx.lineTo(W,c); ctx.lineTo(W,H-c); ctx.lineTo(W-c,H); ctx.lineTo(c,H); ctx.lineTo(0,H-c); ctx.lineTo(0,c); ctx.closePath();
  }
  ctx.clip();
}
function drawBackground(ctx){
  ctx.clearRect(0,0,W,H);
  beginClip(ctx);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
  if(S.bgimg){ const img=new Image(); img.src=S.bgimg; img.onload=()=>{ ctx.globalAlpha=.18; const r=Math.max(W/img.width,H/img.height); ctx.drawImage(img,(W-img.width*r)/2,(H-img.height*r)/2,img.width*r,img.height*r); ctx.globalAlpha=1; drawTemplateOverlay(ctx); }; }
  drawTemplateOverlay(ctx);
  if(S.glass!=='off'){
    ctx.globalAlpha = S.glass==='strong'? .25 : .15;
    const grad=ctx.createLinearGradient(0,0,W,0); grad.addColorStop(0,'#fff'); grad.addColorStop(1,'transparent'); ctx.fillStyle=grad; ctx.fillRect(W*.62,0,W*.38,H);
    ctx.globalAlpha=1;
  }
  ctx.restore();
}
function drawTemplateOverlay(ctx){
  const {cat, seed}=S.template;
  const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,S.c1); g.addColorStop(1,S.c2);
  switch(cat){
    case 'glass': overlayWaves(ctx,g,22+6*(seed%5)); break;
    case 'waves': overlayWaves(ctx,g,18+4*(seed%5)); break;
    case 'angles': poly(ctx,[0,0,W*.74,0,W,H*.38,W,H,0,H,0,0],g); break;
    case 'diagonal': poly(ctx,[0,H,W*.62,0,W,0,W,H,0,H],g); break;
    case 'circles': circleGrad(ctx,W*.22,H*.72,140,g); circleGrad(ctx,W*.78,H*.32,160,g); break;
    case 'ribbon': poly(ctx,[0,H*.68,W,H*.36,W,H,0,H],g); break;
    case 'luxe': ctx.fillStyle='#0b0f26'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='rgba(0,0,0,.16)'; for(let i=0;i<8;i++){ line(ctx,0,i*80+24,W,i*80+6); } circleGrad(ctx,W*.14,H*.22,60,g); break;
    case 'mesh': aurora(ctx,S.c1,S.c2,seed); break;
    case 'grid': gridLines(ctx); poly(ctx,[0,0,W*.6,0,0,H*.28,0,0],g); break;
    case 'neon': neonStripes(ctx,S.c1,S.c2,seed); break;
    case 'shards': shards(ctx,S.c1,S.c2,seed); break;
    case 'circuit': circuit(ctx,S.c1,S.c2,seed); break;
  }
}
function overlayWaves(ctx,fill,amp){ ctx.fillStyle=fill; ctx.beginPath(); ctx.moveTo(0,H); ctx.lineTo(0,H*.62); for(let x=0;x<=W;x+=8){ const y=H*.62 + Math.sin((x/W)*Math.PI)*amp; ctx.lineTo(x,y);} ctx.lineTo(W,H); ctx.closePath(); ctx.fill(); }
function circleGrad(ctx,x,y,r,fill){ ctx.fillStyle=fill; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }
function line(ctx,x1,y1,x2,y2){ ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
function gridLines(ctx){ ctx.strokeStyle='rgba(0,0,0,.12)'; for(let x=0;x<W;x+=24) line(ctx,x,0,x,H); for(let y=0;y<H;y+=24) line(ctx,0,y,W,y); }
function aurora(ctx,a,b,seed){ const r=(n)=>((seed*9301+49297*n)%233280)/233280; ctx.globalAlpha=.7; for(let i=0;i<3;i++){ const x=W*r(i), y=H*r(i+1), rx=120+80*r(i+2), ry=80+60*r(i+3); const p=ctx.createRadialGradient(x,y,10,x,y,Math.max(rx,ry)); p.addColorStop(0,a); p.addColorStop(1,'transparent'); ctx.fillStyle=p; ctx.beginPath(); ctx.ellipse(x,y,rx,ry, r(i+4)*Math.PI, 0, Math.PI*2); ctx.fill(); } ctx.globalAlpha=1; }
function neonStripes(ctx,a,b,seed){ const n=10+(seed%6); for(let i=0;i<n;i++){ const grad=ctx.createLinearGradient(0,0,W,H); grad.addColorStop(0,a); grad.addColorStop(1,b); ctx.fillStyle=grad; ctx.globalAlpha=.22; const y=(H/n)*i; ctx.fillRect(-20,y,W+40,12+(i%3)*6); } ctx.globalAlpha=1; }
function shards(ctx,a,b,seed){ const r=(n)=>((seed*9301+49297*n)%233280)/233280; for(let k=0;k<7;k++){ ctx.beginPath(); ctx.moveTo(W*r(k),H*r(k+1)); for(let j=0;j<4;j++) ctx.lineTo(W*r(k+j+2),H*r(k+j+3)); ctx.closePath(); const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,a); g.addColorStop(1,b); ctx.fillStyle=g; ctx.globalAlpha=.18; ctx.fill(); } ctx.globalAlpha=1; }
function circuit(ctx,a,b,seed){ ctx.strokeStyle='rgba(0,0,0,.22)'; ctx.lineWidth=1; for(let i=0;i<8;i++){ const y=(H/9)*(i+1); line(ctx,10,y,W-10,y); } ctx.globalAlpha=.2; const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,a); g.addColorStop(1,b); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); ctx.globalAlpha=1; }
function roundRectPath(ctx,x,y,w,h,r){ ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); }

/* ===== Text fit & draw layer ===== */
function textFit(ctx,text,w,desired,min,weight=400){
  let s=desired; ctx.font=`${weight} ${s}px/1.3 Inter, system-ui, sans-serif`;
  if(!S.autofit) return s;
  while(s>min && ctx.measureText(text).width>w){ s-=1; ctx.font=`${weight} ${s}px/1.3 Inter, system-ui, sans-serif`; }
  return s;
}
function drawLayer(ctx,l,live=false){
  ctx.save();
  ctx.translate(l.x + l.w/2, l.y + l.h/2); ctx.rotate((l.rot||0)*Math.PI/180); ctx.translate(-l.w/2, -l.h/2);
  if(l.type==='glass'){
    ctx.fillStyle='rgba(255,255,255,.18)'; roundRect(ctx,0,0,l.w,l.h,Math.min(18,l.w/4,l.h/4),true,false);
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=1.2; roundRect(ctx,0,0,l.w,l.h,Math.min(18,l.w/4,l.h/4),false,true);
  } else if(l.type==='logo' && S.logo){
    const img=new Image(); img.onload=()=>{ ctx.save(); ctx.beginPath(); ctx.arc(l.w/2,l.h/2,Math.min(l.w,l.h)/2,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,0,0,l.w,l.h); ctx.restore(); ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(l.w/2,l.h/2,Math.min(l.w,l.h)/2,0,Math.PI*2); ctx.stroke(); if(live) drawEditor(); }; img.src=S.logo;
  } else if(l.type==='qr' && S.qr){
    const tmp=document.createElement('canvas'); QRCode.toCanvas(tmp,S.qr,{margin:1,width:l.w},()=>{ ctx.drawImage(tmp,0,0,l.w,l.h); if(live) drawEditor(); });
  } else if(l.type==='icon' && l.emoji){
    ctx.font=`900 ${Math.floor(l.h*0.86)}px/1 system-ui, Apple Color Emoji, Segoe UI Emoji`; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(l.emoji, l.w/2, l.h/2+2);
  } else if(l.type==='text'){
    const weight=l.weight||400, color=l.color||'#0d0f16', align=l.align||'left'; let s=l.size||14;
    ctx.fillStyle=color; ctx.textBaseline='top'; ctx.textAlign=align;
    s=textFit(ctx, l.text||'', l.w-4, s, 10, weight);
    ctx.font=`${weight} ${s}px/1.25 Inter, system-ui, sans-serif`; const x=align==='left'?0:align==='center'?l.w/2:l.w; ctx.fillText(l.text||'', x, 0);
  } else if(l.type==='contacts'){
    ctx.fillStyle=l.color||'#0d0f16'; let s=l.size||12; ctx.font=`400 ${s}px/1.4 Inter, system-ui`; const lines=[];
    if(S.phones) S.phones.split(';').map(t=>t.trim()).filter(Boolean).forEach(t=>lines.push('üìû '+t));
    if(S.emails) S.emails.split(';').map(t=>t.trim()).filter(Boolean).forEach(t=>lines.push('‚úâÔ∏è '+t));
    if(S.website) lines.push('üåê '+S.website); if(S.address) lines.push('üìç '+S.address);
    const needH=lines.length*(s+6); if(S.autofit && needH>l.h){ s=Math.max(10,Math.floor((l.h-6*lines.length)/Math.max(1,lines.length))); ctx.font=`400 ${s}px/1.4 Inter, system-ui`; }
    let y=0; lines.forEach(t=>{ let txt=t; while(ctx.measureText(txt).width>l.w && txt.length>3){ txt=txt.slice(0,-1); } ctx.fillText(txt,0,y); y+=s+6; });
  } else if(l.type==='socials'){
    ctx.fillStyle=l.color||'#0d0f16'; let s=l.size||12; ctx.font=`400 ${s}px/1.4 Inter, system-ui`; const arr=parseSocials(S.socials); let y=0;
    arr.forEach(([k,v])=>{ let txt=iconFor(k)+' '+v; while(ctx.measureText(txt).width>l.w && txt.length>3){ txt=txt.slice(0,-1);} ctx.fillText(txt,0,y); y+=s+6; });
  }
  ctx.restore();
}
function roundRect(ctx,x,y,w,h,r,fill,stroke){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);if(fill)ctx.fill();if(stroke)ctx.stroke();}

/* ===== Selection & interactions ===== */
function drawSelection(ctx,l){
  ctx.save(); const cx=l.x + l.w/2, cy=l.y + l.h/2;
  ctx.translate(cx,cy); ctx.rotate((l.rot||0)*Math.PI/180); ctx.translate(-l.w/2,-l.h/2);
  ctx.strokeStyle='rgba(123,157,255,.95)'; ctx.setLineDash([6,4]); ctx.lineWidth=1.2; ctx.strokeRect(0,0,l.w,l.h); ctx.setLineDash([]);
  const hs=8, pts=[[0,0],[l.w,0],[l.w,l.h],[0,l.h]]; ctx.fillStyle='#7ba0ff'; pts.forEach(p=>ctx.fillRect(p[0]-hs/2,p[1]-hs/2,hs,hs));
  const rx=l.w/2, ry=-24; ctx.beginPath(); ctx.moveTo(l.w/2,0); ctx.lineTo(rx,ry); ctx.stroke(); ctx.beginPath(); ctx.arc(rx,ry,6,0,Math.PI*2); ctx.fillStyle='#ffb45a'; ctx.fill();
  ctx.restore();
}
function pointInLayer(px,py,l){ const cx=l.x + l.w/2, cy=l.y + l.h/2; const s=Math.sin(-(l.rot||0)*Math.PI/180), c=Math.cos(-(l.rot||0)*Math.PI/180);
  const dx=px - cx, dy=py - cy; const lx = c*dx - s*dy + l.w/2, ly = s*dx + c*dy + l.h/2; return lx>=0 && ly>=0 && lx<=l.w && ly<=l.h; }
function hitHandle(px,py,l){ const cx=l.x+l.w/2, cy=l.y+l.h/2; const s=Math.sin(-(l.rot||0)*Math.PI/180), c=Math.cos(-(l.rot||0)*Math.PI/180);
  const toLocal=(x,y)=>{const dx=x-cx, dy=y-cy; return {x:c*dx - s*dy + l.w/2, y:s*dx + c*dy + l.h/2};};
  const P=toLocal(px,py); const hs=10; const corners=[[0,0,'nw'],[l.w,0,'ne'],[l.w,l.h,'se'],[0,l.h,'sw']];
  for(const [x,y,name] of corners){ if(Math.abs(P.x-x)<hs && Math.abs(P.y-y)<hs) return {type:'scale',corner:name}; }
  if(Math.abs(P.x-l.w/2)<10 && Math.abs(P.y-(-24))<12) return {type:'rotate'};
  if(P.x>=0 && P.y>=0 && P.x<=l.w && P.y<=l.h) return {type:'move'};
  return null;
}

let sel=null, drag=null, start={x:0,y:0}, startL=null;
editor.addEventListener('pointerdown',e=>{
  const rect=editor.getBoundingClientRect(); const x=(e.clientX-rect.left)*(W/rect.width), y=(e.clientY-rect.top)*(H/rect.height);
  const L=layers();
  for(let i=L.length-1;i>=0;i--){
    const l=L[i]; const h=hitHandle(x,y,l);
    if(h){ if(l.lock){toast('Calque verrouill√©'); return;} sel=l.id; drag={kind:h.type,corner:h.corner}; start={x,y}; startL=JSON.parse(JSON.stringify(l)); buildLayersUI(); drawEditor(); return; }
  }
  sel=null; buildLayersUI(); drawEditor();
});
window.addEventListener('pointermove',e=>{
  if(!drag||!sel) return; const rect=editor.getBoundingClientRect(); const x=(e.clientX-rect.left)*(W/rect.width), y=(e.clientY-rect.top)*(H/rect.height);
  const L=layers(); const l=L.find(v=>v.id===sel); if(!l) return; const dx=x-start.x, dy=y-start.y;
  if(drag.kind==='move'){ l.x=clamp(startL.x+dx,0,W-l.w); l.y=clamp(startL.y+dy,0,H-l.h);
    if(S.guides){ if(Math.abs(l.x-SAFE.x)<6) l.x=SAFE.x; if(Math.abs(l.y-SAFE.y)<6) l.y=SAFE.y;
      if(Math.abs((l.x+l.w)-(SAFE.x+SAFE.w))<6) l.x=SAFE.x+SAFE.w-l.w;
      if(Math.abs((l.y+l.h)-(SAFE.y+SAFE.h))<6) l.y=SAFE.y+SAFE.h-l.h; }
  } else if(drag.kind==='scale'){
    if(drag.corner==='se'){ l.w=clamp(startL.w+dx,40,W); l.h=clamp(startL.h+dy,24,H); }
    if(drag.corner==='ne'){ l.w=clamp(startL.w+dx,40,W); l.h=clamp(startL.h-dy,24,H); l.y=startL.y+(startL.h-l.h); }
    if(drag.corner==='sw'){ l.w=clamp(startL.w-dx,40,W); l.h=clamp(startL.h+dy,24,H); l.x=startL.x+(startL.w-l.w); }
    if(drag.corner==='nw'){ l.w=clamp(startL.w-dx,40,W); l.h=clamp(startL.h-dy,24,H); l.x=startL.x+(startL.w-l.w); l.y=startL.y+(startL.h-l.h); }
  } else if(drag.kind==='rotate'){
    const cx=startL.x+startL.w/2, cy=startL.y+startL.h/2; l.rot=Math.round((Math.atan2(y-cy,x-cx)*180/Math.PI + 90));
  }
  setLayers(L); drawEditor();
});
window.addEventListener('pointerup',()=>{ drag=null; startL=null; });

/* ===== Layers UI ===== */
function buildLayersUI(){
  const L=layers(); const box=$('#layers'); box.innerHTML='';
  L.forEach(l=>{
    const d=document.createElement('div'); d.className='layer'+(sel===l.id?' sel':''); d.onclick=()=>{ sel=l.id; buildLayersUI(); drawEditor(); };
    d.innerHTML=`<div style="width:22px;text-align:center">${iconLayer(l.type)}</div><div style="flex:1">${nameLayer(l)}</div><div class="muted" style="font-size:.85rem">${Math.round(l.x)},${Math.round(l.y)}</div>`;
    box.appendChild(d);
  });
  buildProps();
}
function iconLayer(t){ return t==='text'?'üî§':t==='logo'?'üñºÔ∏è':t==='glass'?'üßä':t==='qr'?'üî≥':t==='contacts'?'‚òéÔ∏è':t==='socials'?'üí¨':t==='icon'?'‚≠ê':'üì¶'; }
function nameLayer(l){
  if(l.type==='text') return (l.bind||'Texte') + (l.text?` ‚Äî ‚Äú${l.text.slice(0,14)}${l.text.length>14?'‚Ä¶':''}‚Äù`:'' );
  if(l.type==='logo') return 'Logo'; if(l.type==='glass') return 'Bloc glass'; if(l.type==='qr') return 'QR';
  if(l.type==='contacts') return 'Contacts'; if(l.type==='socials') return 'R√©seaux'; if(l.type==='icon') return 'Ic√¥ne m√©tier'; return 'Calque';
}
function buildProps(){
  const L=layers(); const p=$('#props'); p.innerHTML=''; const l=L.find(v=>v.id===sel);
  if(!l){ p.innerHTML='<div class="muted">S√©lectionne un calque pour modifier ses propri√©t√©s.</div>'; return; }
  const add=(html,cb)=>{ const w=document.createElement('div'); w.innerHTML=html; p.appendChild(w); cb&&cb(w); };
  add(`<div class="tools"><button class="btn sm" id="lock">${l.lock?'üîì D√©verrouiller':'üîí Verrouiller'}</button><button class="btn sm" id="del">üóëÔ∏è Supprimer</button></div>`,w=>{
    w.querySelector('#lock').onclick=()=>{ l.lock=!l.lock; setLayers(L); buildLayersUI(); };
    w.querySelector('#del').onclick=()=>{ setLayers(L.filter(x=>x.id!==l.id)); sel=null; drawEditor(); buildLayersUI(); };
  });
  add(`<div class="row"><label>X<input type="number" id="px" value="${Math.round(l.x)}"></label><label>Y<input type="number" id="py" value="${Math.round(l.y)}"></label></div>`,w=>{
    const px=w.querySelector('#px'), py=w.querySelector('#py'); px.oninput=()=>{ l.x=clamp(+px.value||0,0,W-l.w); setLayers(L); drawEditor(); }; py.oninput=()=>{ l.y=clamp(+py.value||0,0,H-l.h); setLayers(L); drawEditor(); };
  });
  add(`<div class="row"><label>L<input type="number" id="pw" value="${Math.round(l.w)}"></label><label>H<input type="number" id="ph" value="${Math.round(l.h)}"></label></div>`,w=>{
    const pw=w.querySelector('#pw'), ph=w.querySelector('#ph'); pw.oninput=()=>{ l.w=clamp(+pw.value||40,40,W); setLayers(L); drawEditor(); }; ph.oninput=()=>{ l.h=clamp(+ph.value||24,24,H); setLayers(L); drawEditor(); };
  });
  add(`<div class="row"><label>Rotation (¬∞)<input type="number" id="prot" value="${Math.round(l.rot||0)}"></label></div>`,w=>{
    const prot=w.querySelector('#prot'); prot.oninput=()=>{ l.rot=(+prot.value||0); setLayers(L); drawEditor(); };
  });
  if(l.type==='text'){
    add(`<div class="row"><label>Taille<input type="number" id="ps" min="10" max="38" value="${l.size||14}"></label><label>Couleur<input type="color" id="pc" value="${l.color||'#0d0f16'}"></label></div>`,w=>{
      w.querySelector('#ps').oninput=ev=>{ l.size=clamp(+ev.target.value||14,10,38); setLayers(L); drawEditor(); };
      w.querySelector('#pc').oninput=ev=>{ l.color=ev.target.value; setLayers(L); drawEditor(); };
    });
    add(`<div class="row"><label>Alignement<select id="pal"><option value="left">Gauche</option><option value="center">Centre</option><option value="right">Droite</option></select></label><label>Graisse<select id="pwgt"><option value="400">Normal</option><option value="600">Semi-bold</option><option value="800">Bold</option></select></label></div>`,w=>{
      const pal=w.querySelector('#pal'), pwgt=w.querySelector('#pwgt'); pal.value=l.align||'left'; pwgt.value=String(l.weight||400);
      pal.oninput=()=>{ l.align=pal.value; setLayers(L); drawEditor(); };
      pwgt.oninput=()=>{ l.weight=+pwgt.value; setLayers(L); drawEditor(); };
    });
    add(`<label>Texte<input type="text" id="ptx" value="${(l.text||'').replace(/"/g,'&quot;')}"></label>`,w=>{
      const ptx=w.querySelector('#ptx'); ptx.oninput=()=>{ l.text=ptx.value; if(l.bind){ S[l.bind]=l.text; save(); } setLayers(L); drawEditor(); };
    });
  }
}

/* ===== Editor controls ===== */
$('#faceFront').onclick=()=>{ S.side='front'; save(); ensureBaseLayers(); sel=null; drawEditor(); buildLayersUI(); };
$('#faceBack').onclick=()=>{ S.side='back'; save(); ensureBaseLayers(); sel=null; drawEditor(); buildLayersUI(); };
$('#toggleGuides').onclick=()=>{ S.guides=!S.guides; save(); drawEditor(); };
$('#addText').onclick=()=>{ const L=layers(); const N={id:newId(),type:'text',text:'Nouveau texte',x:SAFE.x+10,y:SAFE.y+10,w:300,h:36,size:14,weight:600,align:'left',color:'#0d0f16',rot:0}; setLayers([...L,N]); sel=N.id; drawEditor(); buildLayersUI(); };
$('#addGlass').onclick=()=>{ const L=layers(); const N={id:newId(),type:'glass',x:SAFE.x+200,y:SAFE.y+40,w:280,h:110,rot:0}; setLayers([...L,N]); sel=N.id; drawEditor(); buildLayersUI(); };
$('#addJob').onclick=()=>{ const emoji=jobToEmoji(S.job); if(!emoji){ toast('Choisis un m√©tier (√âtape 4)'); return; } const L=layers(); const N={id:newId(),type:'icon',emoji,x:W*.82-60,y:H*.32-60,w:120,h:120,rot:0}; setLayers([...L,N]); sel=N.id; drawEditor(); buildLayersUI(); };
$('#addLogo').onclick=()=>{ if(!S.logo){ toast('Ajoute un logo en √âtape 5'); return; } const L=layers(); const N={id:newId(),type:'logo',x:SAFE.x+W*.6,y:SAFE.y+20,w:120,h:120,rot:0}; setLayers([...L,N]); sel=N.id; drawEditor(); buildLayersUI(); };
$('#addQR').onclick=()=>{ if(!S.qr){ toast('Ajoute une URL QR en √âtape 4'); return; } const L=layers(); const N={id:newId(),type:'qr',x:W-220,y:H-220,w:170,h:170,rot:0}; setLayers([...L,N]); sel=N.id; drawEditor(); buildLayersUI(); };
$('#lockLayer').onclick=()=>{ const L=layers(); const l=L.find(v=>v.id===sel); if(!l){toast('S√©lectionne un calque');return;} l.lock=!l.lock; setLayers(L); buildLayersUI(); };
$('#deleteLayer').onclick=()=>{ const L=layers(); if(!sel) return; setLayers(L.filter(v=>v.id!==sel)); sel=null; drawEditor(); buildLayersUI(); };
$('#toFront').onclick=()=>{ const L=layers(); const i=L.findIndex(v=>v.id===sel); if(i<0) return; const [x]=L.splice(i,1); L.push(x); setLayers(L); drawEditor(); buildLayersUI(); };
$('#toBack').onclick=()=>{ const L=layers(); const i=L.findIndex(v=>v.id===sel); if(i<0) return; const [x]=L.splice(i,1); L.unshift(x); setLayers(L); drawEditor(); buildLayersUI(); };
$('#resetLayout').onclick=()=>{ setLayers([]); ensureBaseLayers(); drawEditor(); buildLayersUI(); };

/* ===== Drawing orchestration ===== */
function drawEditor(){
  ectx.clearRect(0,0,W,H);
  drawBackground(ectx);
  if(S.guides){ ectx.save(); ectx.strokeStyle='rgba(138,162,255,.9)'; ectx.setLineDash([6,6]); ectx.strokeRect(SAFE.x,SAFE.y,SAFE.w,SAFE.h); ectx.restore(); }
  layers().forEach(l=>drawLayer(ectx,l,true));
  if(sel){ const l=layers().find(x=>x.id===sel); if(l) drawSelection(ectx,l); }
}

/* ===== Export ===== */
async function renderSide(side, clean=false){
  // force sync avec les champs r√©cents
  syncBaseLayersFromFields();
  const c=document.createElement('canvas'); c.width=W; c.height=H; const ctx=c.getContext('2d');
  drawBackground(ctx);
  const L = side==='front'? layersFront : layersBack;
  for(const l of L){ await drawLayerSync(ctx,l); }
  if(!clean) await watermark(c,'CR√âATIVE ENTREPRISE');
  return c;
}
function drawLayerSync(ctx,l){ return new Promise(resolve=>{
  if(l.type==='logo' && S.logo){ const img=new Image(); img.onload=()=>{ ctx.save(); ctx.translate(l.x+l.w/2,l.y+l.h/2); ctx.rotate((l.rot||0)*Math.PI/180); ctx.beginPath(); ctx.arc(0,0,Math.min(l.w,l.h)/2,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,-l.w/2,-l.h/2,l.w,l.h); ctx.restore(); resolve(); }; img.src=S.logo; return; }
  if(l.type==='qr' && S.qr){ const tmp=document.createElement('canvas'); QRCode.toCanvas(tmp,S.qr,{margin:1,width:l.w},()=>{ ctx.save(); ctx.translate(l.x+l.w/2,l.y+l.h/2); ctx.rotate((l.rot||0)*Math.PI/180); ctx.drawImage(tmp,-l.w/2,-l.h/2,l.w,l.h); ctx.restore(); resolve(); }); return; }
  drawLayer(ctx,l,false); resolve();
});}
async function watermark(c,text){ const ctx=c.getContext('2d'); ctx.globalAlpha=.9; ctx.fillStyle='rgba(0,0,0,.65)'; ctx.font='600 16px/1 Inter, system-ui'; const pad=16; const tw=ctx.measureText(text+' ‚Äî signe').width; ctx.fillText(text+' ‚Äî signe', c.width - tw - pad, c.height - 24); }
$('#dlMarked').onclick=async()=>{ try{ const f=await renderSide('front',false); const b=await renderSide('back',false); f.toBlob(bf=>saveAs(bf,'carte_recto_filigran√©e.png'),'image/png',0.95); b.toBlob(bb=>saveAs(bb,'carte_verso_filigran√©e.png'),'image/png',0.95);}catch(e){toast('Export PNG √©chou√©'); console.error(e);} };
$('#dlMarkedPdf').onclick=async()=>{ try{ const f=await renderSide('front',false); const b=await renderSide('back',false); const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:[W,H]}); pdf.addImage(f.toDataURL('image/png',0.95),'PNG',0,0,W,H); pdf.addPage([W,H]); pdf.addImage(b.toDataURL('image/png',0.95),'PNG',0,0,W,H); saveAs(pdf.output('blob'),'carte_filigran√©e.pdf'); }catch(e){toast('Export PDF √©chou√©'); console.error(e);} };
$('#dlClean').onclick=async()=>{ const code=($('#proCode').value||'').trim().toUpperCase(); if(code!=='CREATIVE'){ toast('Code invalide'); return; } try{ const f=await renderSide('front',true); const b=await renderSide('back',true); f.toBlob(bf=>saveAs(bf,'carte_recto_HD.png'),'image/png',0.95); b.toBlob(bb=>saveAs(bb,'carte_verso_HD.png'),'image/png',0.95); const {jsPDF}=window.jspdf; const pdf=new jsPDF({unit:'pt',format:[W,H]}); pdf.addImage(f.toDataURL('image/png',0.95),'PNG',0,0,W,H); pdf.addPage([W,H]); pdf.addImage(b.toDataURL('image/png',0.95),'PNG',0,0,W,H); saveAs(pdf.output('blob'),'carte_HD.pdf'); }catch(e){toast('Export propre √©chou√©'); console.error(e);} };

/* ===== Utils ===== */
function parseSocials(s){ return (s||'').split(';').map(t=>t.trim()).filter(Boolean).map(t=>{const [k,...rest]=t.split(':'); return [k?.toLowerCase()?.trim()||'',rest.join(':').trim()];}).filter(([k,v])=>k&&v); }
function iconFor(k){ const m={whatsapp:'üü¢',facebook:'üìò',instagram:'üü£',tiktok:'üéµ',twitter:'üê¶',x:'‚ùå',linkedin:'üíº',youtube:'‚ñ∂Ô∏è',telegram:'üí¨'}; return m[k]||'üîó'; }
function jobToEmoji(job){ const map={'D√©veloppeur':'üßë‚Äçüíª','Designer':'üé®','Photographe':'üì∏','M√©decin':'‚öïÔ∏è','Avocat':'‚öñÔ∏è','Immobilier':'üè†','Chef cuisinier':'üë®‚Äçüç≥','Ing√©nieur':'üõ†Ô∏è'}; return map[job]||''; }

/* ===== Init ===== */
$('#cat').value='all';
ensureBaseLayers();
if(S.step===1) buildTpls();
if(S.step===6) drawEditor();
})();
</script>
</body>
</html>

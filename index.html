<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<title>Cartes Futuristes ‚Äî √âditeur par Martial H</title>
<meta name="theme-color" content="#0b0c12">
<style>
  :root{
    --bg:#0b0c12; --panel:#10131e; --glass1:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.03);
    --line:#1f2436; --txt:#f3f6ff; --muted:#cfd6ff; --orange:#ff8a00; --orange2:#ffb45a; --ok:#2fe7a3; --ko:#ff6b6b;
    --cyan:#31d3ff; --vio:#b967ff;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--txt);font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1300px 900px at 85% -10%, #171c34 0, transparent 60%),
      radial-gradient(900px 700px at 0% 110%, #1b132a 0, transparent 60%),
      linear-gradient(180deg,#0b0c12,#090a10);
  }
  header{
    position:sticky;top:0;z-index:50;
    background:linear-gradient(180deg,rgba(12,14,22,.92),rgba(10,12,18,.8));backdrop-filter:blur(12px);
    border-bottom:1px solid var(--line)
  }
  .head{max-width:1280px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:conic-gradient(from 10deg,var(--orange),var(--vio),var(--cyan),var(--orange));
    box-shadow:0 10px 28px rgba(255,138,0,.35), inset 0 0 16px rgba(255,255,255,.2)}
  .title{font-weight:900;letter-spacing:.02em}
  .subtitle{color:var(--muted);font-size:.9rem}
  .pill{border:1px solid var(--line);border-radius:999px;padding:.35rem .7rem;background:linear-gradient(180deg,var(--glass1),var(--glass2));font-weight:800}

  .wrap{max-width:1280px;margin:12px auto 90px;padding:0 12px;display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:1100px){ .wrap{grid-template-columns:320px 1fr} }

  .panel{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,var(--glass1),var(--glass2));backdrop-filter:blur(10px);padding:12px}
  h2{margin:.2rem 0 .6rem}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1}
  input[type=text],input[type=url],input[type=color],input[type=number],select,textarea{
    width:100%;padding:.7rem .8rem;border:1px solid #2a2f44;border-radius:10px;background:#0d111c;color:#f3f6ff
  }
  input[type=file]{width:100%}
  .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:.7rem .95rem;font-weight:800;color:#f3f6ff;background:linear-gradient(180deg,rgba(26,28,40,.95),rgba(14,16,26,.95));cursor:pointer}
  .btn.primary{color:#0a0c12;border-color:transparent;background:linear-gradient(135deg,rgba(255,138,0,.9),rgba(255,180,90,.9))}
  .btn.ghost{background:transparent}
  .btn.small{padding:.45rem .6rem;font-size:.9rem}
  .sep{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.12),transparent);margin:8px 0}

  .canvasWrap{position:relative;border:1px dashed #2a2f44;border-radius:14px;background:#0c0f16;display:grid;place-items:center;padding:10px;min-height:280px}
  canvas{max-width:100%;height:auto;border-radius:12px;background:#fff;box-shadow:0 20px 60px rgba(0,0,0,.35)}
  .hud{display:flex;gap:6px;flex-wrap:wrap}

  .footerBar{position:fixed;left:0;right:0;bottom:0;z-index:60;display:flex;justify-content:center}
  .bar{max-width:1280px;margin:0 auto 10px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(180deg,var(--glass1),var(--glass2));backdrop-filter:blur(10px);display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grow{flex:1 1 220px}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:84px;padding:.6rem .9rem;border:1px solid var(--line);border-radius:10px;background:linear-gradient(180deg,var(--glass1),var(--glass2));z-index:80}
  .help{font-size:.9rem;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="head">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">Cartes de visite futuristes ‚Äî √âditeur</div>
        <div class="subtitle">Bienvenue ü§ó ‚Äì cr√©√© par <b>Martial H</b>, gratuit & 100% local</div>
      </div>
    </div>
    <div class="pill" id="status">S√©lectionne, d√©place, redimensionne, pivote</div>
  </div>
</header>

<div class="wrap">
  <!-- Panneau gauche -->
  <aside class="panel" id="left">
    <h2>üé® Apparence</h2>
    <div class="row">
      <label>Template
        <select id="tpl">
          <option value="neo">Neo Glass</option>
          <option value="ribbon">Rubans dynamiques</option>
          <option value="grid">Grille n√©on</option>
          <option value="split">Split diagonal</option>
          <option value="orbit">Cercles orbitaux</option>
          <option value="monolith">Monolith luxe</option>
        </select>
      </label>
    </div>
    <div class="row">
      <label>Accent A <input id="c1" type="color" value="#ff8a00"></label>
      <label>Accent B <input id="c2" type="color" value="#31d3ff"></label>
    </div>
    <div class="row">
      <label>M√©tier (preset)
        <select id="job">
          <option value="none">‚Äî Aucun preset ‚Äî</option>
          <option value="dev">D√©veloppeur</option>
          <option value="photo">Photographe</option>
          <option value="design">Designer</option>
          <option value="law">Avocat</option>
          <option value="med">M√©decin</option>
          <option value="hair">Coiffeur</option>
          <option value="food">Restaurant</option>
          <option value="music">Musicien</option>
        </select>
      </label>
    </div>

    <div class="sep"></div>
    <h2>‚ûï √âl√©ment</h2>
    <div class="row">
      <button class="btn small" id="addText">Texte</button>
      <button class="btn small" id="addIcon">Ic√¥ne m√©tier</button>
      <button class="btn small" id="addShape">Forme</button>
    </div>
    <div class="row" style="margin-top:6px">
      <label>Image libre<input type="file" id="addImage" accept="image/*"></label>
      <label>Logo / Photo<input type="file" id="addLogo" accept="image/*"></label>
    </div>
    <div class="row">
      <label>QR (URL)<input type="url" id="qrUrl" placeholder="https://‚Ä¶"></label>
      <button class="btn small" id="addQR">Ajouter QR</button>
    </div>

    <div class="sep"></div>
    <h2>‚úèÔ∏è S√©lection</h2>
    <div class="help" id="selHelp">Aucun √©l√©ment s√©lectionn√©. Touchez / cliquez sur la carte.</div>
    <div id="selPanel" hidden>
      <div class="row">
        <label>Texte / Alt
          <input type="text" id="propText" placeholder="Double-clic sur la carte pour √©diter">
        </label>
      </div>
      <div class="row">
        <label>Taille <input type="number" id="propSize" min="8" max="96" value="18"></label>
        <label>Rotation (¬∞) <input type="number" id="propRot" min="-180" max="180" value="0"></label>
      </div>
      <div class="row">
        <label>Couleur <input type="color" id="propColor" value="#0d0f16"></label>
        <label>Opacit√© (%) <input type="number" id="propAlpha" min="10" max="100" value="100"></label>
      </div>
      <div class="row">
        <button class="btn small" id="bringF">Monter</button>
        <button class="btn small" id="sendB">Descendre</button>
        <button class="btn small" id="dup">Dupliquer</button>
        <button class="btn small" id="del">Supprimer</button>
      </div>
    </div>

    <div class="sep"></div>
    <h2>‚ÑπÔ∏è Identit√© (rapide)</h2>
    <div class="row">
      <label>Nom complet<input id="idName" type="text" placeholder="Nom Pr√©nom"></label>
    </div>
    <div class="row">
      <label>Poste / Fonction<input id="idRole" type="text" placeholder="Poste"></label>
    </div>
    <div class="row">
      <label>Entreprise<input id="idCompany" type="text" placeholder="Entreprise"></label>
    </div>
    <div class="row">
      <label>Slogan<input id="idTag" type="text" placeholder="Slogan (optionnel)"></label>
    </div>
    <div class="help">Astuce : ces champs ajoutent/actualisent des blocs texte pr√©-styl√©s que tu pourras d√©placer.</div>
  </aside>

  <!-- √âditeur -->
  <main class="panel">
    <div class="hud">
      <div class="pill">Taille carte : 1005 √ó 650 px (85√ó55 mm @300 dpi)</div>
      <div class="pill">Guides & magn√©tisme actifs</div>
    </div>
    <div class="canvasWrap">
      <canvas id="card" width="1005" height="650" aria-label="Zone d‚Äô√©dition"></canvas>
    </div>
    <p class="help" style="margin-top:8px">‚ú® Double-clic / double-tap sur un texte pour l‚Äô√©diter. Pincer pour zoomer un √©l√©ment sur mobile. Poign√©e ronde = rotation, carr√©e = redimensionnement.</p>
  </main>
</div>

<!-- Barre d‚Äôactions -->
<div class="footerBar">
  <div class="bar">
    <div class="grow">Export : <span class="help">gratuit = filigran√©, propre = code <b>CREATIVE</b></span></div>
    <button class="btn" id="dlPng">PNG (filigran√©)</button>
    <button class="btn" id="dlPdf">PDF (filigran√©)</button>
    <input id="cleanCode" class="btn" style="max-width:160px" placeholder="Code">
    <button class="btn primary" id="dlClean">Export PROPRE</button>
  </div>
</div>

<div id="toast" class="toast" hidden>OK</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
(()=>{'use strict';
/* ---------- Utils ---------- */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const toast=t=>{ const el=$('#toast'); el.textContent=t; el.hidden=false; setTimeout(()=>el.hidden=true,1500); };

const CAN_W=1005, CAN_H=650;
const canvas=$('#card'), ctx=canvas.getContext('2d');

/* ---------- State ---------- */
let state = JSON.parse(localStorage.getItem('biz_card_state')||'null') || {
  tpl:'neo', c1:'#ff8a00', c2:'#31d3ff',
  elements:[], // each: {id,type,x,y,w,h,rot,txt,color,alpha,src,jobIcon,shape}
};
let sel = null; // selected element id
const save=()=>localStorage.setItem('biz_card_state', JSON.stringify(state));

/* ---------- Presets ---------- */
const JOBS={
  dev: { c1:'#00ffa8', c2:'#31d3ff', icon:'üíª' },
  photo:{ c1:'#ff8a00', c2:'#ffb45a', icon:'üì∑' },
  design:{ c1:'#b967ff', c2:'#31d3ff', icon:'üé®' },
  law:{ c1:'#ffd36f', c2:'#ff8a00', icon:'‚öñÔ∏è' },
  med:{ c1:'#31d3ff', c2:'#7affd2', icon:'ü©∫' },
  hair:{ c1:'#ff9ad5', c2:'#ffc36a', icon:'‚úÇÔ∏è' },
  food:{ c1:'#ff6b6b', c2:'#ffb45a', icon:'üçΩÔ∏è' },
  music:{ c1:'#8ee6ff', c2:'#b967ff', icon:'üéµ' },
};
function applyJob(job){
  if(!JOBS[job]) return;
  state.c1=JOBS[job].c1; state.c2=JOBS[job].c2;
  const exists=state.elements.find(e=>e.type==='icon');
  if(!exists){
    state.elements.push(newIcon(JOBS[job].icon));
  }else{
    exists.txt=JOBS[job].icon;
  }
  save(); draw();
}

/* ---------- Element factories ---------- */
const uid=()=>Math.random().toString(36).slice(2,9);
function newText(text, x=60, y=140, size=28, weight=800){
  return {id:uid(), type:'text', x, y, w:360, h:size*1.2, rot:0, txt:text, color:'#0d0f16', alpha:1, weight, align:'left'};
}
function newIcon(emoji='üíª', x=CAN_W*0.82, y=CAN_H*0.32){
  return {id:uid(), type:'icon', x, y, w:120, h:120, rot:0, txt:emoji, color:'#0d0f16', alpha:1};
}
function newShape(kind='glass', x=CAN_W*0.18, y=CAN_H*0.72){
  return {id:uid(), type:'shape', x, y, w:220, h:120, rot:0, shape:kind, color:'#ffffff', alpha:.12};
}
function newImage(src, x=CAN_W*0.18, y=CAN_H*0.68){
  return {id:uid(), type:'image', x, y, w:180, h:180, rot:0, src, alpha:1};
}
function newQR(url, x=CAN_W-200, y=CAN_H-200){
  return {id:uid(), type:'qr', x, y, w:160, h:160, rot:0, txt:url, alpha:1};
}

/* ---------- Background templates ---------- */
function drawBG(){
  // base white
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,CAN_W,CAN_H);
  // accents
  const g=ctx.createLinearGradient(0,0,CAN_W,CAN_H); g.addColorStop(0,state.c1); g.addColorStop(1,state.c2);
  const g2=ctx.createLinearGradient(0,CAN_H,CAN_W,0); g2.addColorStop(0,state.c2); g2.addColorStop(1,state.c1);

  if(state.tpl==='neo'){
    // big blurred blobs (glass style)
    blob( -120,  80, 280, g, .25);
    blob(  780, 420, 300, g2,.22);
    ribbon([[0,CAN_H*0.68],[CAN_W,CAN_H*0.38],[CAN_W,CAN_H],[0,CAN_H]], g,.85);
    ribbon([[0,0],[CAN_W*0.72,0],[0,CAN_H*0.28],[0,0]], g2,.9);
  } else if(state.tpl==='ribbon'){
    ribbon([[0,CAN_H*0.70],[CAN_W,CAN_H*0.42],[CAN_W,CAN_H],[0,CAN_H]], g,.95);
    blob( 140,120,180,g,.22); blob(830,90,160,g2,.18);
  } else if(state.tpl==='grid'){
    ctx.fillStyle='#0b0f26'; ctx.fillRect(0,0,CAN_W,CAN_H);
    ctx.strokeStyle='rgba(255,255,255,.08)'; for(let i=0;i<CAN_H;i+=40){ ctx.beginPath(); ctx.moveTo(0,i+20); ctx.lineTo(CAN_W,i+8); ctx.stroke(); }
    blob( 120, 80,260,g,.25); blob( 820, 440,260,g2,.20);
  } else if(state.tpl==='split'){
    ribbon([[0,0],[CAN_W*0.7,0],[CAN_W,CAN_H*0.42],[CAN_W,0],[0,0]], g,.95);
    blob( 200, 460,260,g2,.25);
  } else if(state.tpl==='orbit'){
    ctx.fillStyle='#fff'; circle(CAN_W*0.20, CAN_H*0.75, 160, g,.95);
    circle(CAN_W*0.80, CAN_H*0.30, 200, g2,.1);
    circle(CAN_W*0.78, CAN_H*0.32, 140, g2,.08);
  } else if(state.tpl==='monolith'){
    ctx.fillStyle='#0b0f26'; ctx.fillRect(0,0,CAN_W,CAN_H);
    ctx.strokeStyle='rgba(0,0,0,.18)'; for(let i=0;i<8;i++){ ctx.beginPath(); ctx.moveTo(0,i*80+24); ctx.lineTo(CAN_W,i*80+6); ctx.stroke(); }
    circle(CAN_W*0.14, CAN_H*0.22, 60, g,.95);
  }

  // helpers
  function blob(x,y,r,fill,alpha){ ctx.save(); ctx.globalAlpha=alpha; ctx.fillStyle=fill; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore(); }
  function ribbon(pts,fill,alpha){ ctx.save(); ctx.globalAlpha=alpha; ctx.fillStyle=fill; ctx.beginPath(); ctx.moveTo(pts[0][0],pts[0][1]); for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i][0],pts[i][1]); ctx.closePath(); ctx.fill(); ctx.restore(); }
  function circle(x,y,r,fill,alpha){ ctx.save(); ctx.globalAlpha=alpha; ctx.fillStyle=fill; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); ctx.restore(); }
}

/* ---------- Drawing elements ---------- */
function draw(){
  // bg
  drawBG();

  // guides (selection)
  drawGuides();

  // elements
  for(const el of state.elements){
    drawElement(el);
  }

  // selection handles
  if(sel){
    const el = state.elements.find(e=>e.id===sel);
    if(el) drawHandles(el);
  }
}
function drawElement(el){
  ctx.save();
  ctx.translate(el.x, el.y);
  ctx.rotate(el.rot*Math.PI/180);
  ctx.globalAlpha = el.alpha ?? 1;

  if(el.type==='text'){
    ctx.fillStyle = el.color||'#0d0f16';
    const size = Math.max(8, Math.min(96, el.h||24));
    const weight = el.weight||600;
    ctx.font = `${weight} ${size}px/1.15 Inter, system-ui, sans-serif`;
    ctx.textAlign='left'; ctx.textBaseline='top';
    // clip to width if too long:
    const maxW = el.w||360; let text = el.txt||'Texte';
    while(ctx.measureText(text).width > maxW && text.length>1) text = text.slice(0,-1);
    ctx.fillText(text, - (el.anchorX||0), - (el.anchorY||0));
  }

  if(el.type==='icon'){
    const r = Math.min(el.w,el.h)/2;
    // glass circle
    const g=ctx.createLinearGradient(-r,-r,r,r);
    g.addColorStop(0, state.c1); g.addColorStop(1, state.c2);
    ctx.globalAlpha=.22; ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha=1;
    ctx.font = `700 ${Math.floor(r*0.9)}px/1 Inter, system-ui`; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillStyle=el.color||'#0d0f16';
    ctx.fillText(el.txt||'üíª', 0, 0);
  }

  if(el.type==='shape'){
    const w=el.w, h=el.h;
    ctx.fillStyle=el.color||'#fff'; ctx.globalAlpha=el.alpha??.12;
    roundRect(-w/2,-h/2,w,h, 18, true);
    ctx.globalAlpha=1;
  }

  if(el.type==='image' && el._img){
    const w=el.w, h=el.h; ctx.drawImage(el._img, -w/2, -h/2, w, h);
  }

  if(el.type==='qr' && el._qr){
    ctx.drawImage(el._qr, -el.w/2, -el.h/2, el.w, el.h);
  }

  ctx.restore();
}
function roundRect(x,y,w,h,r,fill){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.arcTo(x+w,y,x+w,y+h,r);
  ctx.arcTo(x+w,y+h,x,y+h,r);
  ctx.arcTo(x,y+h,x,y,r);
  ctx.arcTo(x,y,x+w,y,r);
  if(fill) ctx.fill();
}

/* ---------- Guides & snapping ---------- */
let showGuides = false;
function drawGuides(){
  if(!showGuides) return;
  ctx.save();
  ctx.strokeStyle='rgba(0,0,0,.25)';
  ctx.setLineDash([6,6]);
  // center lines
  ctx.beginPath(); ctx.moveTo(CAN_W/2,0); ctx.lineTo(CAN_W/2,CAN_H); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0,CAN_H/2); ctx.lineTo(CAN_W,CAN_H/2); ctx.stroke();
  // margins
  ctx.setLineDash([4,8]);
  const m=40;
  ctx.strokeRect(m,m, CAN_W-2*m, CAN_H-2*m);
  ctx.restore();
}
const SNAP=6;
function snap(val,targets){ for(const t of targets){ if(Math.abs(val-t)<=SNAP) return t; } return val; }

/* ---------- Hit testing / selection ---------- */
function getAt(x,y){
  // return topmost
  for(let i=state.elements.length-1;i>=0;i--){
    const el=state.elements[i];
    if(hit(el,x,y)) return el.id;
  }
  return null;
}
function hit(el, px, py){
  const s = Math.sin(-el.rot*Math.PI/180), c = Math.cos(-el.rot*Math.PI/180);
  const dx = px - el.x, dy = py - el.y;
  const lx = dx*c - dy*s, ly = dx*s + dy*c;
  const hw=(el.w||200)/2, hh=(el.h||50)/2;
  return lx>=-hw && lx<=hw && ly>=-hh && ly<=hh;
}
function select(id){
  sel=id;
  const has=!!sel;
  $('#selPanel').hidden = !has;
  $('#selHelp').hidden = has;
  if(!has) return;
  const el=state.elements.find(e=>e.id===sel);
  $('#propText').value = el.txt||'';
  $('#propSize').value = Math.round(el.h||24);
  $('#propRot').value = Math.round(el.rot||0);
  $('#propColor').value = el.color||'#0d0f16';
  $('#propAlpha').value = Math.round((el.alpha??1)*100);
}

/* ---------- Pointer interactions (mouse + touch) ---------- */
let drag=null; // {mode:'move'|'scale'|'rotate', id, ox, oy, start, startW,H, startRot, touches?}
const getPos=e=>{
  if(e.touches && e.touches[0]){
    const r=canvas.getBoundingClientRect();
    return { x: (e.touches[0].clientX - r.left) * (canvas.width / r.width),
             y: (e.touches[0].clientY - r.top)  * (canvas.height / r.height) };
  }else{
    const r=canvas.getBoundingClientRect();
    return { x: (e.clientX - r.left) * (canvas.width / r.width),
             y: (e.clientY - r.top)  * (canvas.height / r.height) };
  }
};
function nearHandle(el,px,py){
  // corner for scale (bottom-right), circle on top for rotate
  const ang=el.rot*Math.PI/180;
  function tr(ax,ay){ const s=Math.sin(ang), c=Math.cos(ang); return { x: el.x + ax*c - ay*s, y: el.y + ax*s + ay*c }; }
  const scale=tr(el.w/2, el.h/2);
  const rotH = tr(0, -el.h/2 - 28);
  const d1=Math.hypot(scale.x-px, scale.y-py);
  const d2=Math.hypot(rotH.x-px, rotH.y-py);
  if(d1<18) return 'scale';
  if(d2<16) return 'rotate';
  return null;
}
function drawHandles(el){
  ctx.save();
  ctx.translate(el.x,el.y); ctx.rotate(el.rot*Math.PI/180);
  ctx.strokeStyle='rgba(0,0,0,.45)'; ctx.setLineDash([6,6]); ctx.strokeRect(-el.w/2,-el.h/2, el.w, el.h);
  // scale handle
  ctx.setLineDash([]); ctx.fillStyle='#fff'; ctx.strokeStyle='rgba(0,0,0,.6)';
  ctx.fillRect(el.w/2-8, el.h/2-8, 16,16); ctx.strokeRect(el.w/2-8, el.h/2-8, 16,16);
  // rotate handle
  ctx.beginPath(); ctx.arc(0, -el.h/2-28, 10, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.restore();
}

canvas.addEventListener('pointerdown', e=>{
  canvas.setPointerCapture(e.pointerId);
  const p=getPos(e);
  const id=getAt(p.x,p.y);
  if(id){
    select(id);
    const el=state.elements.find(x=>x.id===id);
    const h=nearHandle(el,p.x,p.y);
    if(h==='scale'){
      drag={mode:'scale', id, startW:el.w, startH:el.h, cx:el.x, cy:el.y, start:p};
    }else if(h==='rotate'){
      drag={mode:'rotate', id, startRot:el.rot, cx:el.x, cy:el.y, start:p};
    }else{
      drag={mode:'move', id, ox:p.x-el.x, oy:p.y-el.y};
    }
  }else{
    select(null);
  }
});
canvas.addEventListener('pointermove', e=>{
  if(!drag) return;
  const p=getPos(e);
  const el=state.elements.find(x=>x.id===drag.id); if(!el) return;
  if(drag.mode==='move'){
    let nx=p.x - drag.ox, ny=p.y - drag.oy;
    // snapping
    nx = snap(nx, [CAN_W/2, 40, CAN_W-40]);
    ny = snap(ny, [CAN_H/2, 40, CAN_H-40]);
    el.x=nx; el.y=ny; save(); draw();
  }else if(drag.mode==='scale'){
    // scale from center -> keep min sizes
    const dx=p.x - drag.cx, dy=p.y - drag.cy;
    const w=Math.max(40, Math.abs(dx)*2), h=Math.max(30, Math.abs(dy)*2);
    el.w=w; el.h=h; save(); draw();
  }else if(drag.mode==='rotate'){
    const ang = Math.atan2(p.y-drag.cy, p.x-drag.cx) * 180/Math.PI;
    el.rot = Math.round(ang+90); // intuitive
    save(); draw();
  }
});
['pointerup','pointercancel','pointerleave'].forEach(ev=> canvas.addEventListener(ev, ()=> drag=null));

// Double-click / double-tap to edit text
let lastTap=0;
canvas.addEventListener('pointerup', e=>{
  const now=Date.now();
  if(now-lastTap<300){ // double
    const p=getPos(e); const id=getAt(p.x,p.y);
    if(id){
      const el=state.elements.find(x=>x.id===id);
      if(el.type==='text' || el.type==='icon'){
        const v=prompt('√âditer le texte :', el.txt||'');
        if(v!=null){ el.txt=v; save(); draw(); }
      } else if(el.type==='qr'){
        const v=prompt('URL du QR :', el.txt||'https://');
        if(v!=null){ el.txt=v; buildQR(el); save(); draw(); }
      }
    }
  }
  lastTap=now;
});

/* ---------- Selection panel bindings ---------- */
$('#propText').addEventListener('input', ()=>{
  if(!sel) return; const el=state.elements.find(e=>e.id===sel); if(!el) return;
  el.txt=$('#propText').value; if(el.type==='qr') buildQR(el);
  save(); draw();
});
$('#propSize').addEventListener('input', ()=>{
  if(!sel) return; const el=state.elements.find(e=>e.id===sel); el.h=Number($('#propSize').value)||el.h; save(); draw();
});
$('#propRot').addEventListener('input', ()=>{
  if(!sel) return; const el=state.elements.find(e=>e.id===sel); el.rot=Number($('#propRot').value)||0; save(); draw();
});
$('#propColor').addEventListener('input', ()=>{
  if(!sel) return; const el=state.elements.find(e=>e.id===sel); el.color=$('#propColor').value; save(); draw();
});
$('#propAlpha').addEventListener('input', ()=>{
  if(!sel) return; const el=state.elements.find(e=>e.id===sel); el.alpha=(Number($('#propAlpha').value)||100)/100; save(); draw();
});
$('#bringF').addEventListener('click', ()=>{ if(!sel) return; const i=state.elements.findIndex(e=>e.id===sel); state.elements.push(...state.elements.splice(i,1)); save(); draw(); });
$('#sendB').addEventListener('click', ()=>{ if(!sel) return; const i=state.elements.findIndex(e=>e.id===sel); state.elements.unshift(...state.elements.splice(i,1)); save(); draw(); });
$('#dup').addEventListener('click', ()=>{ if(!sel) return; const el=state.elements.find(e=>e.id===sel); const copy=JSON.parse(JSON.stringify(el)); copy.id=uid(); copy.x+=20; copy.y+=20; state.elements.push(copy); save(); draw(); });
$('#del').addEventListener('click', ()=>{ if(!sel) return; state.elements=state.elements.filter(e=>e.id!==sel); sel=null; save(); draw(); select(null); });

/* ---------- Toolbar actions ---------- */
$('#tpl').value = state.tpl;
$('#c1').value = state.c1; $('#c2').value = state.c2;

$('#tpl').addEventListener('change', e=>{ state.tpl=e.target.value; save(); draw(); });
$('#c1').addEventListener('input', e=>{ state.c1=e.target.value; save(); draw(); });
$('#c2').addEventListener('input', e=>{ state.c2=e.target.value; save(); draw(); });

$('#job').addEventListener('change', e=>{ const v=e.target.value; if(v==='none') return; applyJob(v); toast('Preset m√©tier appliqu√©'); });

$('#addText').addEventListener('click', ()=>{
  const t=newText('Nom Pr√©nom', 60, 120, 30, 800); state.elements.push(t);
  const r=newText('Poste', 60, 160, 18, 600); state.elements.push(r);
  save(); draw(); select(r.id);
});
$('#addIcon').addEventListener('click', ()=>{ const i=newIcon('üíº'); state.elements.push(i); save(); draw(); select(i.id); });
$('#addShape').addEventListener('click', ()=>{ const s=newShape('glass'); state.elements.push(s); save(); draw(); select(s.id); });
$('#addImage').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; const data=await fileToDataURL(f); const im=newImage(data); await loadImgTo(im); state.elements.push(im); save(); draw(); select(im.id); e.target.value='';
});
$('#addLogo').addEventListener('change', async e=>{
  const f=e.target.files[0]; if(!f) return; const data=await fileToDataURL(f); const im=newImage(data, CAN_W*0.82, CAN_H*0.32); await loadImgTo(im); state.elements.push(im); save(); draw(); select(im.id); e.target.value='';
});
$('#addQR').addEventListener('click', async ()=>{
  const url=$('#qrUrl').value.trim(); if(!url) return toast('Entre une URL'); const qr=newQR(url); await buildQR(qr); state.elements.push(qr); save(); draw(); select(qr.id);
});

/* ---------- Quick identity (auto blocs) ---------- */
$('#idName').addEventListener('input', ()=>addOrUpdateText('name',$('#idName').value, 60, 120, 32, 800));
$('#idRole').addEventListener('input', ()=>addOrUpdateText('role',$('#idRole').value, 60, 160, 18, 600));
$('#idCompany').addEventListener('input', ()=>addOrUpdateText('company',$('#idCompany').value, 60, 60, 16, 700));
$('#idTag').addEventListener('input', ()=>addOrUpdateText('tag',$('#idTag').value, 60, 85, 14, 400, 'rgba(0,0,0,.7)'));

function addOrUpdateText(key,val,x,y,size,weight=600,color='#0d0f16'){
  let el = state.elements.find(e=>e.type==='text' && e._key===key);
  if(!el){ el=newText(val||key, x,y,size,weight); el._key=key; el.color=color; state.elements.push(el); }
  el.txt=val; el.h=size; el.color=color; save(); draw();
}

/* ---------- Assets build ---------- */
async function loadImgTo(el){
  const img=new Image(); await new Promise((ok,ko)=>{ img.onload=ok; img.onerror=ko; img.src=el.src; });
  el._img=img;
}
async function buildQR(el){
  const tmp=document.createElement('canvas');
  await new Promise((ok)=> QRCode.toCanvas(tmp, el.txt||'', {margin:1,width:320,color:{dark:'#000',light:'#fff'}}, ok));
  el._qr=tmp;
}

/* ---------- Export ---------- */
async function exportPNG(clean){
  await ensureAssets();
  // Filigrane si pas clean
  const c = clean ? canvas : await withWatermark(canvas,'CR√âATIVE ENTREPRISE ‚Äî signe');
  c.toBlob(b=> saveAs(b, clean?'carte_HD.png':'carte_filigran√©e.png'),'image/png',0.95);
}
async function exportPDF(clean){
  await ensureAssets();
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF({unit:'pt',format:[CAN_W,CAN_H]});
  const c = clean ? canvas : await withWatermark(canvas,'CR√âATIVE ENTREPRISE ‚Äî signe');
  pdf.addImage(c.toDataURL('image/png',0.95),'PNG',0,0,CAN_W,CAN_H);
  const blob=pdf.output('blob'); saveAs(blob, clean?'carte_HD.pdf':'carte_filigran√©e.pdf');
}
async function ensureAssets(){
  // (no-op here, assets already embedded by build steps when adding)
}
async function withWatermark(srcCanvas, mark){
  const c=document.createElement('canvas'); c.width=srcCanvas.width; c.height=srcCanvas.height;
  const cctx=c.getContext('2d'); cctx.drawImage(srcCanvas,0,0);
  cctx.globalAlpha=.9; cctx.fillStyle='rgba(0,0,0,.65)'; cctx.font='600 16px/1 Inter, system-ui';
  const pad=16; const tw=cctx.measureText(mark).width;
  cctx.fillText(mark, c.width - tw - pad, c.height - 24);
  return c;
}
$('#dlPng').addEventListener('click', ()=> exportPNG(false));
$('#dlPdf').addEventListener('click', ()=> exportPDF(false));
$('#dlClean').addEventListener('click', ()=>{
  const code=($('#cleanCode').value||'').trim().toUpperCase();
  if(code==='CREATIVE'){ exportPNG(true); exportPDF(true); toast('Export propre en cours‚Ä¶'); }
  else toast('Code invalide');
});

/* ---------- Load previous & init ---------- */
(async function init(){
  // rebuild images/qrs
  for(const el of state.elements){
    if(el.type==='image' && el.src) await loadImgTo(el);
    if(el.type==='qr' && el.txt) await buildQR(el);
  }
  // hydrate identity quick fields
  const n=state.elements.find(e=>e._key==='name'); $('#idName').value=n?.txt||'';
  const r=state.elements.find(e=>e._key==='role'); $('#idRole').value=r?.txt||'';
  const c=state.elements.find(e=>e._key==='company'); $('#idCompany').value=c?.txt||'';
  const t=state.elements.find(e=>e._key==='tag'); $('#idTag').value=t?.txt||'';

  draw();
})();

/* ---------- Keyboard shortcuts (desktop) ---------- */
document.addEventListener('keydown', e=>{
  if(!sel) return;
  const el=state.elements.find(x=>x.id===sel); if(!el) return;
  const step = e.shiftKey ? 10 : 2;
  if(['ArrowLeft','ArrowRight','ArrowUp','ArrowDown'].includes(e.key)){
    if(e.key==='ArrowLeft') el.x-=step;
    if(e.key==='ArrowRight') el.x+=step;
    if(e.key==='ArrowUp') el.y-=step;
    if(e.key==='ArrowDown') el.y+=step;
    save(); draw(); e.preventDefault();
  }
  if(e.key==='Delete' || e.key==='Backspace'){ state.elements=state.elements.filter(x=>x.id!==sel); sel=null; save(); draw(); }
});

/* ---------- Done ---------- */
})();
</script>
</body>
</html>

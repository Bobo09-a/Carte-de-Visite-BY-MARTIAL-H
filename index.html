<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover">
<title>G√©n√©rateur de Carte de Visite ‚Äî par Martial H</title>
<meta name="theme-color" content="#0b0c12">
<style>
  :root{
    --bg:#0b0c12; --panel:#10131e; --glass1:rgba(255,255,255,.06); --glass2:rgba(255,255,255,.03);
    --line:#1e2232; --txt:#f3f6ff; --muted:#cfd6ff; --orange:#ff8a00; --orange2:#ffb45a; --ok:#2fe7a3; --ko:#ff6b6b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;color:var(--txt);font-family:system-ui,Inter,Segoe UI,Roboto,Arial,sans-serif;
    background:
      radial-gradient(1200px 800px at 80% -10%, #171c34 0, transparent 60%),
      radial-gradient(900px 600px at 0% 110%, #1b132a 0, transparent 60%),
      linear-gradient(180deg,#0b0c12,#090a10);
  }
  header{
    position:sticky;top:0;z-index:30;
    background:linear-gradient(180deg,rgba(12,14,22,.9),rgba(10,12,18,.75));backdrop-filter:blur(10px);
    border-bottom:1px solid var(--line)
  }
  .head{max-width:1180px;margin:0 auto;padding:10px 12px;display:flex;align-items:center;gap:10px;justify-content:space-between}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:32px;height:32px;border-radius:9px;background:linear-gradient(135deg,var(--orange),var(--orange2));
    box-shadow:0 10px 28px rgba(255,138,0,.35), inset 0 0 16px rgba(255,255,255,.2)}
  .title{font-weight:900;letter-spacing:.02em}
  .subtitle{color:var(--muted);font-size:.9rem}
  .pill{border:1px solid var(--line);border-radius:999px;padding:.35rem .7rem;background:linear-gradient(180deg,var(--glass1),var(--glass2));font-weight:800}

  .wrap{max-width:1180px;margin:10px auto 90px;padding:0 12px}
  .wizard{border:1px solid var(--line);border-radius:14px;background:linear-gradient(180deg,var(--glass1),var(--glass2));backdrop-filter:blur(10px);padding:12px}
  .steps{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:10px}
  .step{display:flex;align-items:center;gap:8px;padding:.45rem .65rem;border-radius:999px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-size:.92rem;cursor:pointer}
  .step.active{outline:2px solid rgba(255,138,0,.65)}
  h2{margin:.3rem 0 .5rem}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .row>*{flex:1}
  input[type=text],input[type=url],input[type=color],input[type=number],textarea,select{
    width:100%;padding:.75rem .8rem;border:1px solid #2a2f44;border-radius:10px;background:#0d111c;color:#f3f6ff
  }
  input[type=file]{width:100%}
  .btn{appearance:none;border:1px solid var(--line);border-radius:10px;padding:.7rem .95rem;font-weight:800;color:#f3f6ff;background:linear-gradient(180deg,rgba(26,28,40,.95),rgba(14,16,26,.95));cursor:pointer}
  .btn.primary{color:#0a0c12;border-color:transparent;background:linear-gradient(135deg,rgba(255,138,0,.85),rgba(255,180,90,.85))}
  .btn.ghost{background:transparent}
  .notice{border:1px dashed #343a55;border-radius:12px;padding:10px;background:rgba(255,255,255,.03)}
  .grid{display:grid;grid-template-columns:1fr;gap:10px}
  @media(min-width:900px){ .grid{grid-template-columns:1fr 1fr} }
  .templates{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px}
  .tpl{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,.02));cursor:pointer}
  .tpl.sel{outline:2px solid rgba(255,138,0,.7)}
  .canvasWrap{display:grid;place-items:center;background:#0c0f16;border:1px dashed #2a2f44;border-radius:12px;padding:8px}
  canvas{max-width:100%;background:#fff;border-radius:10px;box-shadow:0 10px 28px rgba(0,0,0,.35)}
  .footerBar{position:fixed;left:0;right:0;bottom:0;z-index:40;display:flex;justify-content:center}
  .bar{max-width:1180px;margin:0 auto 10px;padding:8px 10px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(180deg,var(--glass1),var(--glass2));backdrop-filter:blur(10px);display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .ok{color:var(--ok)} .ko{color:var(--ko)}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:80px;padding:.6rem .9rem;border:1px solid var(--line);border-radius:10px;background:linear-gradient(180deg,var(--glass1),var(--glass2));z-index:50}
</style>
</head>
<body>
<header>
  <div class="head">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <div class="title">G√©n√©rateur de carte de visite</div>
        <div class="subtitle">Bienvenue ü§ó ‚Äî cr√©√© par <b>Martial H</b>, gratuit et 100% local</div>
      </div>
    </div>
    <div class="pill" id="status">√âtape 1/7</div>
  </div>
</header>

<div class="wrap">
  <div class="wizard">
    <div class="steps" id="steps"></div>

    <!-- √âTAPE 1 : Mod√®le & Couleurs -->
    <section data-step="1">
      <h2>1) Mod√®le & couleurs</h2>
      <p class="muted">Aper√ßus neutres (sans infos perso). Th√®me noir/blanc avec accents orange ‚Äúglass‚Äù.</p>
      <div class="row">
        <label>Mod√®le
          <select id="template">
            <option value="waves">Vagues (futuriste)</option>
            <option value="diagonal">Diagonal pro</option>
            <option value="circles">Cercles premium</option>
            <option value="ribbon">Ruban moderne</option>
            <option value="angles">Angles tech</option>
            <option value="luxe">Luxe sombre</option>
          </select>
        </label>
        <label>Couleur accent A<input id="c1" type="color" value="#ff8a00"></label>
        <label>Couleur accent B<input id="c2" type="color" value="#ffb45a"></label>
      </div>
      <div class="templates" id="tplGrid"></div>
    </section>

    <!-- √âTAPE 2 : Identit√© -->
    <section data-step="2" hidden>
      <h2>2) Identit√©</h2>
      <div class="row">
        <label>Nom complet<input id="name" type="text" placeholder="Nom Pr√©nom"></label>
        <label>Poste / Fonction<input id="role" type="text" placeholder="Poste"></label>
      </div>
      <div class="row">
        <label>Entreprise<input id="company" type="text" placeholder="Entreprise (optionnel)"></label>
        <label>Slogan<input id="tagline" type="text" placeholder="Phrase d‚Äôaccroche (optionnel)"></label>
      </div>
      <div class="row notice">
        <div>
          <b>Taille des textes (aper√ßu & export)</b>
          <div class="row" style="margin-top:6px">
            <label>Nom (px) <input id="sizeName" type="number" min="14" max="36" value="22"></label>
            <label>Sous-titre (px) <input id="sizeSub" type="number" min="10" max="22" value="14"></label>
            <label>Corps (px) <input id="sizeBody" type="number" min="10" max="18" value="12"></label>
          </div>
          <label style="display:flex;gap:8px;align-items:center;margin-top:6px">
            <input id="autofit" type="checkbox" checked>
            <span>Auto-ajuster les textes pour √©viter tout d√©passement</span>
          </label>
        </div>
      </div>
    </section>

    <!-- √âTAPE 3 : Contacts -->
    <section data-step="3" hidden>
      <h2>3) Contacts</h2>
      <div class="row">
        <label>T√©l√©phones (s√©par√©s par ;)<input id="phones" type="text" placeholder="+229‚Ä¶ ; +33‚Ä¶"></label>
      </div>
      <div class="row">
        <label>Emails (s√©par√©s par ;)<input id="emails" type="text" placeholder="exemple@domaine.com"></label>
      </div>
      <div class="row">
        <label>Site web<input id="website" type="url" placeholder="https://site.com"></label>
        <label>Adresse<input id="address" type="text" placeholder="Adresse compl√®te (optionnel)"></label>
      </div>
    </section>

    <!-- √âTAPE 4 : R√©seaux & QR -->
    <section data-step="4" hidden>
      <h2>4) R√©seaux & QR</h2>
      <div class="row">
        <label>R√©seaux (cl√©:valeur; ‚Ä¶)
          <input id="socials" type="text" placeholder="whatsapp:+229‚Ä¶; facebook:@page; instagram:@compte">
        </label>
      </div>
      <div class="row">
        <label>QR Code (URL ou laisser vide)
          <input id="qr" type="url" placeholder="https://votre-lien.com">
        </label>
      </div>
      <p class="muted">Astuce : si tu laisses vide, aucun QR ne sera ajout√©.</p>
    </section>

    <!-- √âTAPE 5 : Visuels -->
    <section data-step="5" hidden>
      <h2>5) Visuels</h2>
      <div class="row">
        <label>Logo / Photo<input id="logo" type="file" accept="image/*"></label>
        <label>Image de fond (optionnel)<input id="bgimg" type="file" accept="image/*"></label>
      </div>
      <div class="notice muted">Les images restent sur ton appareil. Rien n‚Äôest envoy√©.</div>
    </section>

    <!-- √âTAPE 6 : Aper√ßu -->
    <section data-step="6" hidden>
      <h2>6) Aper√ßu (recto & verso)</h2>
      <div class="grid">
        <div><div class="canvasWrap"><canvas id="front" width="1005" height="650"></canvas></div></div>
        <div><div class="canvasWrap"><canvas id="back" width="1005" height="650"></canvas></div></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button class="btn" id="refresh">Mettre √† jour l‚Äôaper√ßu</button>
        <button class="btn ghost" id="swap">‚ÜîÔ∏è Inverser les couleurs</button>
      </div>
    </section>

    <!-- √âTAPE 7 : T√©l√©chargement -->
    <section data-step="7" hidden>
      <h2>7) T√©l√©chargement</h2>
      <p class="muted">Par d√©faut un petit filigrane ‚ÄúCR√âATIVE ENTREPRISE ‚Äî signe‚Äù est ajout√©.</p>
      <div class="row">
        <button class="btn" id="dlMarked">PNG HD (filigran√©)</button>
        <button class="btn" id="dlMarkedPdf">PDF (filigran√©)</button>
      </div>
      <div class="row notice">
        <div class="row">
          <label>Code pour export propre (sans filigrane)
            <input id="proCode" type="text" placeholder="Entrer le code ici">
          </label>
          <button class="btn primary" id="dlClean">Exporter SANS filigrane</button>
        </div>
        <small class="muted">Code requis : <b>CREATIVE</b> (insensible √† la casse).</small>
      </div>
    </section>
  </div>
</div>

<div class="footerBar">
  <div class="bar">
    <button class="btn" id="prev">‚Üê Retour</button>
    <div class="grow" id="hint" style="text-align:center">Compl√®te l‚Äô√©tape puis appuie sur <b>Suivant</b>.</div>
    <button class="btn primary" id="next">Suivant ‚Üí</button>
  </div>
</div>

<div id="toast" class="toast" hidden>Message</div>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
(()=>{'use strict';
/* ====== Helpers ====== */
const $=(s,r=document)=>r.querySelector(s);
const $$=(s,r=document)=>[...r.querySelectorAll(s)];
const toast=(t)=>{ const el=$('#toast'); el.textContent=t; el.hidden=false; setTimeout(()=>el.hidden=true,1800); };
const setStatus=t=> $('#status').textContent=t;
const fileToDataURL = f => new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(f); });
const loadImage = src => new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=rej; img.src=src; });

/* ====== State & persistence ====== */
const CANVAS_W=1005, CANVAS_H=650;
const state = JSON.parse(localStorage.getItem('card_state')||'{}');
Object.assign(state,{
  step: Number(state.step||1),
  template: state.template||'waves',
  c1: state.c1||'#ff8a00',
  c2: state.c2||'#ffb45a',
  name: state.name||'',
  role: state.role||'',
  company: state.company||'',
  tagline: state.tagline||'',
  sizeName: Number(state.sizeName||22),
  sizeSub: Number(state.sizeSub||14),
  sizeBody: Number(state.sizeBody||12),
  autofit: state.autofit!==false, // default ON
  phones: state.phones||'',
  emails: state.emails||'',
  website: state.website||'',
  address: state.address||'',
  socials: state.socials||'',
  qr: state.qr||'',
  logo: state.logo||null,
  bgimg: state.bgimg||null
});
const save=()=> localStorage.setItem('card_state', JSON.stringify(state));

/* ====== Bind fields ====== */
function bindText(id){ const el=$('#'+id); if(!el) return; el.value=(state[id]??''); el.addEventListener('input',()=>{ state[id]=el.value; save(); schedule(); }); }
['template','name','role','company','tagline','phones','emails','website','address','socials','qr'].forEach(bindText);
['c1','c2'].forEach(id=>{ const el=$('#'+id); el.value=state[id]; el.addEventListener('input',()=>{ state[id]=el.value; save(); schedule(); });});
['sizeName','sizeSub','sizeBody'].forEach(id=>{ const el=$('#'+id); el.value=state[id]; el.addEventListener('input',()=>{ const v=Math.max(+el.min, Math.min(+el.max, +el.value||0)); state[id]=v; el.value=v; save(); schedule(); });});
$('#autofit').checked = !!state.autofit;
$('#autofit').addEventListener('change',()=>{ state.autofit=$('#autofit').checked; save(); schedule(); });

$('#logo').addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; state.logo=await fileToDataURL(f); save(); schedule(); });
$('#bgimg').addEventListener('change',async e=>{ const f=e.target.files[0]; if(!f) return; state.bgimg=await fileToDataURL(f); save(); schedule(); });

/* ====== Steps UI (robuste) ====== */
const stepsMeta=['Mod√®le','Identit√©','Contacts','R√©seaux & QR','Visuels','Aper√ßu','T√©l√©chargement'];
const stepsBox=$('#steps');
stepsBox.innerHTML=''; // reset au cas o√π
stepsMeta.forEach((t,i)=>{ const b=document.createElement('div'); b.className='step'; b.dataset.i=String(i+1); b.innerHTML=`<b>${i+1}</b> ${t}`; b.addEventListener('click',()=>goto(i+1)); stepsBox.appendChild(b); });

function showStep(n){
  $$('section[data-step]').forEach(s=> s.hidden = Number(s.dataset.step)!==n);
  $$('.step').forEach(s=> s.classList.toggle('active', Number(s.dataset.i)===n));
  $('#prev').disabled = n===1;
  $('#next').textContent = n===7 ? 'Terminer' : 'Suivant ‚Üí';
  setStatus(`√âtape ${n}/7`);
  if(n===6) drawAll();
}
function goto(n){
  state.step = Math.max(1, Math.min(7, Number(n)||1));
  save();
  showStep(state.step);
}
$('#prev').addEventListener('click', ()=> goto(state.step-1));
$('#next').addEventListener('click', ()=> { if(state.step<7) goto(state.step+1); else toast('Tu peux t√©l√©charger maintenant.'); });

goto(state.step); // affichage initial fiable

/* ====== Templates preview (neutres) ====== */
const tplGrid=$('#tplGrid'); const TPLS=['waves','diagonal','circles','ribbon','angles','luxe'];
tplGrid.innerHTML='';
TPLS.forEach(t=>{
  const c=document.createElement('canvas'); c.width=320; c.height=200; const ctx=c.getContext('2d');
  previewTemplate(ctx,t,state.c1,state.c2);
  const wrap=document.createElement('div'); wrap.className='tpl'+(t===state.template?' sel':''); wrap.appendChild(c);
  wrap.addEventListener('click',()=>{ state.template=t; $('#template').value=t; save(); [...tplGrid.children].forEach(x=>x.classList.remove('sel')); wrap.classList.add('sel'); schedule(); });
  tplGrid.appendChild(wrap);
});
function previewTemplate(ctx,t,c1,c2){
  const W=ctx.canvas.width,H=ctx.canvas.height; const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,c1); g.addColorStop(1,c2);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
  if(t==='waves'){ ctx.fillStyle=g; wave(ctx,0,H*0.55,W,H*0.65,28); ctx.fill(); }
  else if(t==='diagonal'){ ctx.fillStyle=g; poly(ctx,[0,H, W*0.65,0, W,0, W,H, 0,H]); ctx.fill(); }
  else if(t==='circles'){ ctx.fillStyle=g; circle(ctx,W*0.22,H*0.52,60); ctx.fill(); ctx.globalAlpha=.15; circle(ctx,W*0.78,H*0.4,70); ctx.fill(); ctx.globalAlpha=1; }
  else if(t==='ribbon'){ ctx.fillStyle=g; poly(ctx,[0,H*0.65, W,H*0.35, W,H, 0,H]); ctx.fill(); }
  else if(t==='angles'){ ctx.fillStyle=g; poly(ctx,[0,0, W*0.72,0, W,H*0.38, W,H, 0,H, 0,0]); ctx.fill(); }
  else if(t==='luxe'){ ctx.fillStyle='#0b0f26'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='rgba(255,255,255,.2)'; for(let i=0;i<6;i++){ ctx.beginPath(); ctx.moveTo(0,i*34+20); ctx.lineTo(W,i*34+10); ctx.stroke(); } ctx.fillStyle=g; circle(ctx,W*0.15,H*0.25,36); ctx.fill(); }
  function circle(ctx,x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); }
  function poly(ctx,pts){ ctx.beginPath(); ctx.moveTo(pts[0],pts[1]); for(let i=2;i<pts.length;i+=2) ctx.lineTo(pts[i],pts[i+1]); ctx.closePath(); }
  function wave(ctx,x0,y0,w,h,amp){ ctx.beginPath(); ctx.moveTo(0,H); ctx.lineTo(0,y0); for(let x=0;x<=W;x+=10){ const y=y0 + Math.sin((x/W)*Math.PI)*amp; ctx.lineTo(x,y); } ctx.lineTo(W,H); ctx.closePath(); }
}

/* ====== Canvas drawing ====== */
const front=$('#front'), back=$('#back');

function fitBold(ctx, text, maxWidth, desiredPx, minPx){
  let size=desiredPx; ctx.font=`800 ${size}px/1.15 Inter, system-ui, sans-serif`;
  while(size>minPx && ctx.measureText(text).width>maxWidth){ size-=1; ctx.font=`800 ${size}px/1.15 Inter, system-ui, sans-serif`; }
  return size;
}
function fitRegular(ctx, text, maxWidth, desiredPx, minPx, weight=400){
  let size=desiredPx; ctx.font=`${weight} ${size}px/1.45 Inter, system-ui, sans-serif`;
  while(size>minPx && ctx.measureText(text).width>maxWidth){ size-=1; ctx.font=`${weight} ${size}px/1.45 Inter, system-ui, sans-serif`; }
  return size;
}

async function drawAll(){
  try{
    await Promise.all([drawCard(front,true), drawCard(back,false)]);
  }catch(e){ console.error(e); toast('Erreur de rendu'); }
}

async function drawCard(canvas,isFront){
  const ctx=canvas.getContext('2d'); const W=canvas.width,H=canvas.height;
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);

  // BG image (adoucit)
  if(state.bgimg){ const img=await loadImage(state.bgimg); const r=Math.max(W/img.width,H/img.height); ctx.globalAlpha=.18; ctx.drawImage(img,(W-img.width*r)/2,(H-img.height*r)/2,img.width*r,img.height*r); ctx.globalAlpha=1; }

  // Accents orange (glass)
  const g=ctx.createLinearGradient(0,0,W,H); g.addColorStop(0,state.c1); g.addColorStop(1,state.c2);
  const g2=ctx.createLinearGradient(0,H,W,0); g2.addColorStop(0,state.c2); g2.addColorStop(1,state.c1);

  if(state.template==='waves'){ ctx.fillStyle=g; wave(ctx,0,H*0.62,W,H*0.72,40); ctx.fill(); }
  else if(state.template==='diagonal'){ ctx.fillStyle=g; poly(ctx,[0,H, W*0.62,0, W,0, W,H, 0,H]); ctx.fill(); }
  else if(state.template==='circles'){ ctx.fillStyle=g; circle(ctx,W*0.22,H*0.72,140); ctx.fill(); ctx.globalAlpha=.1; circle(ctx,W*0.78,H*0.32,160); ctx.fill(); ctx.globalAlpha=1; }
  else if(state.template==='ribbon'){ ctx.fillStyle=g; poly(ctx,[0,H*0.68, W,H*0.36, W,H, 0,H]); ctx.fill(); ctx.fillStyle=g2; poly(ctx,[0,0, W*0.75,0, 0,H*0.28, 0,0]); ctx.fill(); }
  else if(state.template==='angles'){ ctx.fillStyle=g; poly(ctx,[0,0, W*0.74,0, W,H*0.38, W,H, 0,H, 0,0]); ctx.fill(); }
  else if(state.template==='luxe'){ ctx.fillStyle='#0b0f26'; ctx.fillRect(0,0,W,H); ctx.strokeStyle='rgba(0,0,0,.16)'; for(let i=0;i<8;i++){ ctx.beginPath(); ctx.moveTo(0,i*80+24); ctx.lineTo(W,i*80+6); ctx.stroke(); } ctx.fillStyle=g; circle(ctx,W*0.14,H*0.22,60); ctx.fill(); }

  // Logo/photo (cercle)
  if(state.logo){
    const img=await loadImage(state.logo);
    const r=120/Math.max(img.width,img.height); const w=img.width*r, h=img.height*r;
    const cx=isFront? (W*0.82) : (W*0.18), cy=isFront? (H*0.32) : (H*0.68);
    ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,70,0,Math.PI*2); ctx.clip(); ctx.drawImage(img,cx-w/2,cy-h/2,w,h); ctx.restore();
    ctx.strokeStyle='rgba(0,0,0,.15)'; ctx.lineWidth=4; ctx.beginPath(); ctx.arc(cx,cy,70,0,Math.PI*2); ctx.stroke();
  }

  // Tailles voulues
  let sizeName = Math.max(14, Math.min(36, Number(state.sizeName)||22));
  let sizeSub  = Math.max(10, Math.min(22, Number(state.sizeSub)||14));
  let sizeBody = Math.max(10, Math.min(18, Number(state.sizeBody)||12));

  const nameY=isFront? 120:140;
  const maxNameW = 560;
  const maxLineW = 600;

  // Auto-fit
  if(state.autofit && state.name){ sizeName = fitBold(ctx, state.name, maxNameW, sizeName, 14); }
  if(state.autofit && state.role){ sizeSub = Math.min(sizeSub, fitRegular(ctx, state.role, maxLineW, sizeSub, 10, 600)); }

  // Textes principaux
  ctx.fillStyle='#0d0f16';
  ctx.font=`800 ${sizeName}px/1.15 Inter, system-ui, sans-serif`;
  if(state.name) ctx.fillText(state.name, 40, nameY);

  ctx.font=`600 ${sizeSub}px/1.15 Inter, system-ui, sans-serif`;
  if(state.role) ctx.fillText(state.role, 40, nameY + sizeName + 6);

  // Company / tagline
  const compSize = Math.max(12, Math.min(20, sizeSub));
  let tmpSize = compSize;
  if(state.company && state.autofit) tmpSize = fitRegular(ctx, state.company, maxLineW, compSize, 11, 700);
  ctx.font=`700 ${tmpSize}px/1.2 Inter, system-ui, sans-serif`;
  if(state.company) ctx.fillText(state.company, 40, 40);

  let tagSize = Math.max(11,sizeBody);
  if(state.tagline && state.autofit) tagSize = fitRegular(ctx, state.tagline, maxLineW, tagSize, 10, 400);
  ctx.font=`400 ${tagSize}px/1.45 Inter, system-ui, sans-serif`; ctx.fillStyle='rgba(0,0,0,.78)';
  if(state.tagline) ctx.fillText(state.tagline, 40, 62);

  // Contacts
  ctx.fillStyle='#0d0f16'; ctx.font=`400 ${sizeBody}px/1.45 Inter, system-ui`;
  const lines=[];
  if(state.phones) state.phones.split(';').map(s=>s.trim()).filter(Boolean).forEach(t=>lines.push('üìû '+t));
  if(state.emails) state.emails.split(';').map(s=>s.trim()).filter(Boolean).forEach(t=>lines.push('‚úâÔ∏è '+t));
  if(state.website) lines.push('üåê '+state.website);
  if(state.address) lines.push('üìç '+state.address);
  let y=nameY + sizeName + sizeSub + 14;
  if(state.autofit && y + lines.length*(sizeBody+6) > H-40){
    const avail = H-40 - y; sizeBody = Math.max(10, Math.floor(avail/Math.max(1,lines.length) - 6));
    ctx.font=`400 ${sizeBody}px/1.45 Inter, system-ui`;
  }
  lines.forEach(l=>{
    let text=l; while(ctx.measureText(text).width>maxLineW && text.length>3){ text=text.slice(0,-1); }
    ctx.fillText(text, 40, y); y+= (sizeBody+6);
  });

  // Socials
  const socials=parseSocials(state.socials);
  if(socials.length){
    let sy=nameY + sizeName + sizeSub + 14, sx=W-360;
    ctx.textAlign='left'; ctx.fillStyle='#0d0f16'; ctx.font=`400 ${sizeBody}px/1.4 Inter, system-ui`;
    socials.forEach(([k,v])=>{
      let text=iconFor(k)+' '+v;
      while(ctx.measureText(text).width>300 && text.length>3){ text=text.slice(0,-1); }
      ctx.fillText(text, sx, sy); sy+= (sizeBody+6);
    });
  }

  // QR
  if(state.qr){
    const tmp=document.createElement('canvas');
    QRCode.toCanvas(tmp, state.qr, {margin:1,width:180,color:{dark:'#000',light:'#fff'}}, ()=>{});
    const qx=W-240, qy=H-240;
    ctx.drawImage(tmp,qx,qy,180,180);
    ctx.font=`400 ${Math.max(10,sizeBody-1)}px/1 Inter,system-ui`; ctx.fillStyle='rgba(0,0,0,.7)'; ctx.fillText('Scan me', qx+54, qy+186);
  }

  // helpers
  function circle(ctx,x,y,r){ ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); }
  function poly(ctx,pts){ ctx.beginPath(); ctx.moveTo(pts[0],pts[1]); for(let i=2;i<pts.length;i+=2) ctx.lineTo(pts[i],pts[i+1]); ctx.closePath(); }
  function wave(ctx,x0,y0,w,h,amp){ ctx.beginPath(); ctx.moveTo(0,H); ctx.lineTo(0,y0); for(let x=0;x<=W;x+=8){ const y=y0 + Math.sin((x/W)*Math.PI)*amp; ctx.lineTo(x,y); } ctx.lineTo(W,H); ctx.closePath(); }
}

function parseSocials(s){
  return (s||'').split(';').map(x=>x.trim()).filter(Boolean).map(t=>{
    const [k,...rest]=t.split(':'); return [k?.toLowerCase()?.trim()||'', rest.join(':').trim()];
  }).filter(([k,v])=>k&&v);
}
function iconFor(k){
  const map={whatsapp:'üü¢', facebook:'üìò', instagram:'üü£', tiktok:'üéµ', twitter:'üê¶', x:'‚ùå', linkedin:'üíº', youtube:'‚ñ∂Ô∏è', telegram:'üí¨'};
  return map[k]||'üîó';
}

/* ====== Export ====== */
async function exportPNG({clean=false}={}){
  await drawAll();
  const f=await withWatermark(front, clean?null:'CR√âATIVE ENTREPRISE');
  const b=await withWatermark(back, clean?null:'CR√âATIVE ENTREPRISE');
  f.toBlob(blob=>saveAs(blob, clean?'carte_recto_HD.png':'carte_recto_filigran√©e.png'),'image/png',0.95);
  b.toBlob(blob=>saveAs(blob, clean?'carte_verso_HD.png':'carte_verso_filigran√©e.png'),'image/png',0.95);
}
async function exportPDF({clean=false}={}){
  await drawAll();
  const { jsPDF }=window.jspdf;
  const pdf=new jsPDF({unit:'pt',format:[CANVAS_W,CANVAS_H]});
  const f=await canvasToDataURL(await withWatermark(front, clean?null:'CR√âATIVE ENTREPRISE'));
  pdf.addImage(f,'PNG',0,0,CANVAS_W,CANVAS_H);
  pdf.addPage([CANVAS_W,CANVAS_H]);
  const b=await canvasToDataURL(await withWatermark(back, clean?null:'CR√âATIVE ENTREPRISE'));
  pdf.addImage(b,'PNG',0,0,CANVAS_W,CANVAS_H);
  const blob=pdf.output('blob'); saveAs(blob, clean?'carte_HD.pdf':'carte_filigran√©e.pdf');
}
function canvasToDataURL(c){ return c.toDataURL('image/png',0.95); }
async function withWatermark(srcCanvas, mark){
  if(!mark) return srcCanvas;
  const c=document.createElement('canvas'); c.width=srcCanvas.width; c.height=srcCanvas.height;
  const ctx=c.getContext('2d'); ctx.drawImage(srcCanvas,0,0);
  ctx.globalAlpha=.9; ctx.fillStyle='rgba(0,0,0,.65)'; ctx.font='600 16px/1 Inter, system-ui'; const pad=16; const text= mark + ' ‚Äî signe';
  const tw=ctx.measureText(text).width; ctx.fillText(text, c.width - tw - pad, c.height - 24);
  return c;
}
$('#dlMarked').addEventListener('click', ()=> exportPNG({clean:false}));
$('#dlMarkedPdf').addEventListener('click', ()=> exportPDF({clean:false}));
$('#dlClean').addEventListener('click', async ()=>{
  const code = ($('#proCode').value||'').trim().toUpperCase();
  if(code==='CREATIVE'){ await exportPNG({clean:true}); await exportPDF({clean:true}); toast('Export propre en cours‚Ä¶'); }
  else toast('Code invalide : export propre refus√©.');
});

/* ====== Controls ====== */
$('#refresh').addEventListener('click', ()=> drawAll());
$('#swap').addEventListener('click', ()=>{ const x=state.c1; state.c1=state.c2; state.c2=x; $('#c1').value=state.c1; $('#c2').value=state.c2; save(); drawAll(); });

/* ====== Live schedule ====== */
let timer=null; function schedule(){ clearTimeout(timer); timer=setTimeout(drawAll,120); }

/* First render */
drawAll();
})();
</script>
</body>
</html>
